name: Auto-merge feature branches to develop

# ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ÑĞ»Ğ¸ÑĞ½Ğ¸Ğµ feature Ğ²ĞµÑ‚Ğ¾Ğº Ğ² develop Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¹ ÑĞ±Ğ¾Ñ€ĞºĞ¸
# Ğ¡Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¸ Ğ¿ÑƒÑˆĞµ Ğ² feature/* Ğ²ĞµÑ‚ĞºĞ¸
on:
  push:
    branches:
      - 'feature/**'
      - 'feat/**'

jobs:
  # Ğ¨Ğ°Ğ³ 1: ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ¼ĞµĞ½ÑĞ»Ğ¾ÑÑŒ
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      vision_changed: ${{ steps.changes.outputs.vision }}
      main_changed: ${{ steps.changes.outputs.main }}
      docs_changed: ${{ steps.changes.outputs.docs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ develop
          git fetch origin develop
          
          if git diff --name-only origin/develop HEAD | grep -q "^docker/vision/"; then
            echo "vision=true" >> $GITHUB_OUTPUT
          else
            echo "vision=false" >> $GITHUB_OUTPUT
          fi
          
          if git diff --name-only origin/develop HEAD | grep -q "^docker/main/"; then
            echo "main=true" >> $GITHUB_OUTPUT
          else
            echo "main=false" >> $GITHUB_OUTPUT
          fi
          
          if git diff --name-only origin/develop HEAD | grep -q "^docs/"; then
            echo "docs=true" >> $GITHUB_OUTPUT
          else
            echo "docs=false" >> $GITHUB_OUTPUT
          fi

  # Ğ¨Ğ°Ğ³ 2: Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Vision Pi ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² (ĞµÑĞ»Ğ¸ Ğ±Ñ‹Ğ»Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ)
  build-vision:
    needs: detect-changes
    if: needs.detect-changes.outputs.vision_changed == 'true'
    uses: ./.github/workflows/build-vision-services.yml
    secrets: inherit
    permissions:
      contents: read
      packages: write

  # Ğ¨Ğ°Ğ³ 3: Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Main Pi ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² (ĞµÑĞ»Ğ¸ Ğ±Ñ‹Ğ»Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ)
  build-main:
    needs: detect-changes
    if: needs.detect-changes.outputs.main_changed == 'true'
    uses: ./.github/workflows/build-main-services.yml
    secrets: inherit
    permissions:
      contents: read
      packages: write

  # Ğ¨Ğ°Ğ³ 4: ĞĞ²Ñ‚Ğ¾Ğ¼ĞµÑ€Ğ´Ğ¶ Ğ² develop Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¹ ÑĞ±Ğ¾Ñ€ĞºĞ¸
  auto-merge-to-develop:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-vision, build-main]
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞµÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ½Ğ° ÑĞ±Ğ¾Ñ€ĞºĞ° Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ (Ğ¸Ğ»Ğ¸ Ğ½Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ğ»Ğ°ÑÑŒ)
    if: |
      always() && 
      (needs.build-vision.result == 'success' || needs.build-vision.result == 'skipped') &&
      (needs.build-main.result == 'success' || needs.build-main.result == 'skipped')
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get branch name
        id: branch
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Current branch: $BRANCH_NAME"

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Merge feature branch to develop
        id: merge
        run: |
          FEATURE_BRANCH="${{ steps.branch.outputs.name }}"
          echo "ğŸ”€ Merging $FEATURE_BRANCH to develop..."
          
          # ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ÑÑ Ğ½Ğ° develop
          git fetch origin develop
          git checkout develop
          git pull origin develop
          
          # ĞœĞµÑ€Ğ¶Ğ¸Ğ¼ feature Ğ²ĞµÑ‚ĞºÑƒ
          if git merge --no-ff origin/$FEATURE_BRANCH -m "feat: auto-merge $FEATURE_BRANCH to develop after successful build"; then
            echo "âœ… Merge successful"
            echo "merged=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Merge conflict detected"
            echo "merged=false" >> $GITHUB_OUTPUT
            git merge --abort
            exit 1
          fi

      - name: Push to develop
        if: steps.merge.outputs.merged == 'true'
        run: |
          git push origin develop
          echo "âœ… Successfully pushed to develop!"

      # NOTE: Feature branch deletion disabled
      # Developer should manually delete feature branches after verification
      # This prevents accidental deletion of work-in-progress branches
      #
      # - name: Delete feature branch (optional)
      #   if: steps.merge.outputs.merged == 'true'
      #   run: |
      #     FEATURE_BRANCH="${{ steps.branch.outputs.name }}"
      #     echo "ğŸ—‘ï¸ Deleting merged feature branch: $FEATURE_BRANCH"
      #     git push origin --delete $FEATURE_BRANCH || echo "âš ï¸ Failed to delete remote branch"

      - name: Success notification
        if: steps.merge.outputs.merged == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Feature branch auto-merged to develop!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Branch: ${{ steps.branch.outputs.name }} â†’ develop"
          echo "Commit: $(git rev-parse develop)"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "Changes merged:"
          if [ "${{ needs.detect-changes.outputs.vision_changed }}" == "true" ]; then
            echo "  âœ“ Vision Pi services"
          fi
          if [ "${{ needs.detect-changes.outputs.main_changed }}" == "true" ]; then
            echo "  âœ“ Main Pi services"
          fi
          if [ "${{ needs.detect-changes.outputs.docs_changed }}" == "true" ]; then
            echo "  âœ“ Documentation"
          fi

      - name: Merge conflict notification
        if: steps.merge.outputs.merged == 'false'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸ Auto-merge failed due to conflicts!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Please merge manually:"
          echo "  git checkout develop"
          echo "  git pull"
          echo "  git merge ${{ steps.branch.outputs.name }}"
          echo "  # resolve conflicts"
          echo "  git push origin develop"
          exit 1
