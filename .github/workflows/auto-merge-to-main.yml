name: Create PR to main after build

# ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ PR Ğ² main Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¹ ÑĞ±Ğ¾Ñ€ĞºĞ¸ Ğ’Ğ¡Ğ•Ğ¥ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² Ğ¸Ğ· develop
# Ğ¡Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚:
#   1. ĞŸÑ€Ğ¸ Ğ¿ÑƒÑˆĞµ Ğ² develop (Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ¿ÑƒÑˆ)
on:
  push:
    branches:
      - develop

jobs:
  # Ğ¨Ğ°Ğ³ 1: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ’Ğ¡Ğ• Ğ¾Ğ±Ñ€Ğ°Ğ·Ñ‹ ÑĞ¾Ğ±Ğ¸Ñ€Ğ°ÑÑ‚ÑÑ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾
  build-and-test:
    uses: ./.github/workflows/build-all.yml
    secrets: inherit
    permissions:
      contents: read
      packages: write

  # Ğ¨Ğ°Ğ³ 2: Ğ•ÑĞ»Ğ¸ Ğ’Ğ¡Ğ• ÑĞ±Ğ¾Ñ€ĞºĞ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹, ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ PR Ğ² main
  create-pr-to-main:
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if PR already exists
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_EXISTS=$(gh pr list --head develop --base main --json number --jq length)
          echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT
          echo "Existing PRs: $PR_EXISTS"

      - name: Create Pull Request to main
        if: steps.check-pr.outputs.pr_exists == '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ PR
          PR_BODY="## ğŸ‰ Ready for Production Release

          All services have been built successfully and are ready for production deployment.

          ### Built Services:
          - âœ“ Vision Pi services (oak-d, lslidar, apriltag, led-matrix, voice-assistant)
          - âœ“ Main Pi services (micro-ros-agent, zenoh-router)  
          - âœ“ Base images (ros2-zenoh)

          ### Docker Images:
          All images will be tagged as \`*-humble-latest\` after merge.

          ### Actions Required:
          - Review all changes since last release
          - Test on staging/development robot
          - Verify all services work correctly
          - Merge when ready for production deployment

          ---
          _ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾ GitHub Actions Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¹ ÑĞ±Ğ¾Ñ€ĞºĞ¸ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²_"

          # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ PR
          gh pr create \
            --base main \
            --head develop \
            --title "chore: release develop to main" \
            --body "$PR_BODY" \
            --label "release" \
            --label "autobuild" \
            || echo "Failed to create PR, it may already exist"

      - name: Success notification
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Pull Request to main created for review!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Branch: develop â†’ main"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "All services built successfully:"
          echo "  âœ“ Vision Pi services"
          echo "  âœ“ Main Pi services"
          echo "  âœ“ Base images"
          echo ""
          echo "Please review and merge the PR for production deployment."
