name: Auto-merge develop to main

# ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ÑĞ»Ğ¸ÑĞ½Ğ¸Ğµ develop Ğ² main Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¹ ÑĞ±Ğ¾Ñ€ĞºĞ¸ Ğ’Ğ¡Ğ•Ğ¥ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
# Ğ¡Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚:
#   1. ĞŸÑ€Ğ¸ Ğ¿ÑƒÑˆĞµ Ğ² develop (Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ¿ÑƒÑˆ)
#   2. ĞŸĞ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ğ¼ĞµÑ€Ğ´Ğ¶Ğ° Ğ¸Ğ· feature Ğ²ĞµÑ‚ĞºĞ¸
on:
  push:
    branches:
      - develop
  workflow_run:
    workflows: ["Auto-merge feature branches to develop"]
    types:
      - completed
    branches:
      - develop

jobs:
  # Ğ¨Ğ°Ğ³ 0: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‡Ñ‚Ğ¾ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ workflow Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ»ÑÑ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ (Ğ´Ğ»Ñ workflow_run)
  check-previous-run:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run'
    steps:
      - name: Check workflow run status
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "âŒ Previous workflow failed, skipping auto-merge"
            exit 1
          fi
          echo "âœ… Previous workflow succeeded, continuing..."

  # Ğ¨Ğ°Ğ³ 1: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ’Ğ¡Ğ• Ğ¾Ğ±Ñ€Ğ°Ğ·Ñ‹ ÑĞ¾Ğ±Ğ¸Ñ€Ğ°ÑÑ‚ÑÑ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾
  build-and-test:
    needs: [check-previous-run]
    if: always() && (needs.check-previous-run.result == 'success' || needs.check-previous-run.result == 'skipped')
    uses: ./.github/workflows/build-all.yml
    secrets: inherit
    permissions:
      contents: read
      packages: write

  # Ğ¨Ğ°Ğ³ 2: Ğ•ÑĞ»Ğ¸ Ğ’Ğ¡Ğ• ÑĞ±Ğ¾Ñ€ĞºĞ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹, Ğ¼ĞµÑ€Ğ¶Ğ¸Ğ¼ Ğ² main
  auto-merge:
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ğ¼ĞµÑ€Ğ´Ğ¶Ğ°
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Merge develop to main
        id: merge
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”€ Merging develop to main..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          git fetch origin main
          git checkout main
          git pull origin main
          
          if git merge --no-ff develop -m "chore: auto-merge develop to main after successful build"; then
            echo "merged=true" >> $GITHUB_OUTPUT
            echo "âœ… Merge successful"
          else
            echo "merged=false" >> $GITHUB_OUTPUT
            echo "âŒ Merge conflict detected"
            git merge --abort
            exit 1
          fi

      - name: Push to main
        if: steps.merge.outputs.merged == 'true'
        run: |
          git push origin main
          echo "âœ… Successfully pushed to main!"

      - name: Create release tag (optional)
        if: steps.merge.outputs.merged == 'true'
        run: |
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ñ‚ĞµĞ³ Ñ Ğ´Ğ°Ñ‚Ğ¾Ğ¹
          TAG="release-$(date -u '+%Y%m%d-%H%M%S')"
          git tag -a "$TAG" -m "Automated release from develop to main"
          git push origin "$TAG"
          echo "ğŸ“¦ Created release tag: $TAG"

      - name: Success notification
        if: steps.merge.outputs.merged == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Successfully merged develop to main!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Branch: develop â†’ main"
          echo "Commit: $(git rev-parse HEAD)"
          echo "Tag: release-$(date -u '+%Y%m%d-%H%M%S')"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "All services built successfully:"
          echo "  âœ“ Vision Pi services (oak-d, lslidar, apriltag, led-matrix, voice-assistant)"
          echo "  âœ“ Main Pi services (micro-ros-agent, zenoh-router)"
          echo "  âœ“ Base images (ros2-zenoh)"
          echo ""
          echo "Images will be available with tags:"
          echo "  - *-humble-latest (production)"

      - name: Merge conflict notification
        if: steps.merge.outputs.merged == 'false'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸ Auto-merge failed due to conflicts!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Please merge manually:"
          echo "  git checkout main"
          echo "  git pull"
          echo "  git merge develop"
          echo "  # resolve conflicts"
          echo "  git push origin main"
          exit 1

  # Ğ¨Ğ°Ğ³ 3: Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ main branch Ñ Ñ‚ĞµĞ³Ğ¾Ğ¼ 'latest'
  build-main:
    runs-on: ubuntu-latest
    needs: auto-merge
    if: always() && needs.auto-merge.result == 'success'
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Trigger main build
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Main branch updated, build triggered"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Main branch is now at: $(git rev-parse HEAD)"
          echo "Docker images will be built with '-latest' tags"
          echo ""
          echo "Available at:"
          echo "  ghcr.io/krikz/rob_box:voice-assistant-humble-latest"
          echo "  ghcr.io/krikz/rob_box:oak-d-humble-latest"
          echo "  ghcr.io/krikz/rob_box:lslidar-humble-latest"
          echo "  # ... and all other services"
