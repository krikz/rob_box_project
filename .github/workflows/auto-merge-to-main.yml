name: Auto-merge develop to main

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ª–∏—è–Ω–∏–µ develop –≤ main –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–∏
# –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ –≤ develop
on:
  push:
    branches:
      - develop

jobs:
  # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ –æ–±—Ä–∞–∑—ã —Å–æ–±–∏—Ä–∞—é—Ç—Å—è
  build-and-test:
    uses: ./.github/workflows/build-all.yml
    secrets: inherit
    permissions:
      contents: read
      packages: write

  # –®–∞–≥ 2: –ï—Å–ª–∏ —Å–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞, –º–µ—Ä–∂–∏–º –≤ main
  auto-merge:
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –º–µ—Ä–¥–∂–∞
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Merge develop to main
        run: |
          echo "üîÄ Merging develop to main..."
          git checkout main
          git merge --no-ff develop -m "chore: auto-merge develop to main after successful build"
          git push origin main

      - name: Success notification
        run: |
          echo "‚úÖ Successfully merged develop to main!"
          echo ""
          echo "Branch: develop ‚Üí main"
          echo "Commit: $(git rev-parse HEAD)"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

  # –®–∞–≥ 3: –°–æ–±–∏—Ä–∞–µ–º main branch –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
  build-main:
    runs-on: ubuntu-latest
    needs: auto-merge
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Trigger main build
        run: |
          echo "üöÄ Main branch updated, build will be triggered automatically"
          echo "Main branch is now at: $(git rev-parse HEAD)"
