name: Build All Docker Images

# –ü–æ–ª–Ω–∞—è —Å–±–æ—Ä–∫–∞ –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ (–±–∞–∑–æ–≤—ã–µ + —Å–µ—Ä–≤–∏—Å—ã)
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ –≤—Å—ë —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
on:
  push:
    branches:
      - main  # –ê–≤—Ç–æ—Å–±–æ—Ä–∫–∞ –ø—Ä–∏ –ø—É—à–µ –≤ main
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ (–≤–∫–ª–∞–¥–∫–∞ Actions -> Build All -> Run workflow)
  workflow_call:  # –í—ã–∑–æ–≤ –∏–∑ –¥—Ä—É–≥–∏—Ö workflow (–Ω–∞–ø—Ä–∏–º–µ—Ä, auto-merge)
  schedule:
    # –ù–æ—á–Ω–∞—è —Å–±–æ—Ä–∫–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 UTC (6:00 MSK)
    - cron: '0 3 * * *'

jobs:
  # –®–∞–≥ 1: –°–æ–±–∏—Ä–∞–µ–º –±–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã
  build-base-images:
    uses: ./.github/workflows/build-base-images.yml
    secrets: inherit
    permissions:
      contents: read
      packages: write

  # –®–∞–≥ 2: –°–æ–±–∏—Ä–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã Main Pi (–∑–∞–≤–∏—Å—è—Ç –æ—Ç –±–∞–∑–æ–≤—ã—Ö –æ–±—Ä–∞–∑–æ–≤)
  build-main-services:
    needs: build-base-images
    uses: ./.github/workflows/build-main-services.yml
    secrets: inherit
    permissions:
      contents: read
      packages: write

  # –®–∞–≥ 3: –°–æ–±–∏—Ä–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã Vision Pi (–∑–∞–≤–∏—Å—è—Ç –æ—Ç –±–∞–∑–æ–≤—ã—Ö –æ–±—Ä–∞–∑–æ–≤)
  build-vision-services:
    needs: build-base-images
    uses: ./.github/workflows/build-vision-services.yml
    secrets: inherit
    permissions:
      contents: read
      packages: write

  # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
  verify-all:
    runs-on: ubuntu-latest
    needs: [build-base-images, build-main-services, build-vision-services]
    steps:
      - name: All builds succeeded
        run: |
          echo "üéâ –ü–æ–ª–Ω–∞—è —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
          echo ""
          echo "–ë–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã:"
          echo "  - ghcr.io/krikz/rob_box_base:ros2-zenoh"
          echo "  - ghcr.io/krikz/rob_box_base:rtabmap"
          echo "  - ghcr.io/krikz/rob_box_base:depthai"
          echo "  - ghcr.io/krikz/rob_box_base:pcl"
          echo ""
          echo "Main Pi —Å–µ—Ä–≤–∏—Å—ã:"
          echo "  - ghcr.io/krikz/rob_box:robot-state-publisher"
          echo "  - ghcr.io/krikz/rob_box:rtabmap"
          echo ""
          echo "Vision Pi —Å–µ—Ä–≤–∏—Å—ã:"
          echo "  - ghcr.io/krikz/rob_box:oak-d (with integrated AprilTag detection)"
          echo "  - ghcr.io/krikz/rob_box:lslidar"
