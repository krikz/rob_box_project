name: Build All Docker Images

# –ü–æ–ª–Ω–∞—è —Å–±–æ—Ä–∫–∞ –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ (–±–∞–∑–æ–≤—ã–µ + —Å–µ—Ä–≤–∏—Å—ã)
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ –≤—Å—ë —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  schedule:
    # –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é
    - cron: '0 3 * * 0'  # –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 3:00 UTC

jobs:
  # –®–∞–≥ 1: –°–æ–±–∏—Ä–∞–µ–º –±–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã
  build-base-images:
    uses: ./.github/workflows/build-base-images.yml
    secrets: inherit
    permissions:
      contents: read
      packages: write

  # –®–∞–≥ 2: –°–æ–±–∏—Ä–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã Main Pi (–∑–∞–≤–∏—Å—è—Ç –æ—Ç –±–∞–∑–æ–≤—ã—Ö –æ–±—Ä–∞–∑–æ–≤)
  build-main-services:
    needs: build-base-images
    uses: ./.github/workflows/build-main-services.yml
    secrets: inherit
    permissions:
      contents: read
      packages: write

  # –®–∞–≥ 3: –°–æ–±–∏—Ä–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã Vision Pi (–∑–∞–≤–∏—Å—è—Ç –æ—Ç –±–∞–∑–æ–≤—ã—Ö –æ–±—Ä–∞–∑–æ–≤)
  build-vision-services:
    needs: build-base-images
    uses: ./.github/workflows/build-vision-services.yml
    secrets: inherit
    permissions:
      contents: read
      packages: write

  # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
  verify-all:
    runs-on: ubuntu-latest
    needs: [build-base-images, build-main-services, build-vision-services]
    steps:
      - name: All builds succeeded
        run: |
          echo "üéâ –ü–æ–ª–Ω–∞—è —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
          echo ""
          echo "–ë–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã:"
          echo "  - ghcr.io/krikz/rob_box_base:ros2-zenoh"
          echo "  - ghcr.io/krikz/rob_box_base:rtabmap"
          echo "  - ghcr.io/krikz/rob_box_base:depthai"
          echo "  - ghcr.io/krikz/rob_box_base:pcl"
          echo ""
          echo "Main Pi —Å–µ—Ä–≤–∏—Å—ã:"
          echo "  - ghcr.io/krikz/rob_box:robot-state-publisher"
          echo "  - ghcr.io/krikz/rob_box:rtabmap"
          echo ""
          echo "Vision Pi —Å–µ—Ä–≤–∏—Å—ã:"
          echo "  - ghcr.io/krikz/rob_box:oak-d"
          echo "  - ghcr.io/krikz/rob_box:lslidar"
          echo "  - ghcr.io/krikz/rob_box:apriltag"
