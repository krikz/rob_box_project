# Dockerfile –¥–ª—è Voice Assistant System
# AI –≥–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π LED –∞–Ω–∏–º–∞—Ü–∏–π
#
# –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
#   - rob_box_voice: –≥–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç (AudioNode, STTNode, TTSNode, DialogueNode, LEDNode, SoundNode)
#   - rob_box_animations: LED –º–∞—Ç—Ä–∏—á–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —ç–º–æ—Ü–∏–π –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π
#
# Hardware:
#   - ReSpeaker Mic Array v2.0 (USB, 4 –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, 12√ó RGB LED)
#   - Sound card WM8960 (3.5mm jack –¥–ª—è TTS output)
#   - NeoPixel LED –º–∞—Ç—Ä–∏—Ü—ã (—á–µ—Ä–µ–∑ led_matrix_compositor)
ARG BASE_IMAGE=ghcr.io/krikz/rob_box:nav2-humble-latest
# –í–µ—Ä—Å–∏—è —Å–±–æ—Ä–∫–∏ –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–µ—à–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
ARG BUILD_VERSION=2025-10-12-rtabmap

FROM ${BASE_IMAGE}

ARG ROS_DISTRO=humble

# –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
LABEL org.opencontainers.image.title="Voice Assistant System for Vision Pi"
LABEL org.opencontainers.image.description="AI voice assistant with ReSpeaker and LED animations"
LABEL org.opencontainers.image.source="https://github.com/krikz/rob_box_project"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && apt-get install -y \
    # –ê—É–¥–∏–æ —Å–∏—Å—Ç–µ–º–∞
    python3-pip \
    python3-dev \
    libasound2-dev \
    portaudio19-dev \
    libportaudio2 \
    libportaudiocpp0 \
    ffmpeg \
    alsa-utils \
    pulseaudio \
    # USB –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è ReSpeaker
    libusb-1.0-0 \
    libusb-1.0-0-dev \
    udev \
    # –£—Ç–∏–ª–∏—Ç—ã
    git \
    wget \
    curl \
    unzip \
    usbutils \
    && rm -rf /var/lib/apt/lists/*

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ROS2 –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Å–±–æ—Ä–∫–∏ –ø–∞–∫–µ—Ç–æ–≤ (rob_box_animations —Ç—Ä–µ–±—É–µ—Ç sensor_msgs)
# –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–¥–∞–ª—è–µ–º –∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –∏–∑ base image
# –ü—Ä–æ–±–ª–µ–º–∞: base image (nav2) –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–∞–∫–µ—Ç—ã —Å–æ —Å–ª–æ–º–∞–Ω–Ω—ã–º–∏ CMake configs –ø—Ä–∏ cross-compilation
# –†–µ—à–µ–Ω–∏–µ: apt-get remove --purge + apt-get install –≤ –æ–¥–Ω–æ–º RUN –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —á–∏—Å—Ç—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É
# –ò—Å—Ç–æ—á–Ω–∏–∫: docs/development/DOCKER_BUILD_FIXES.md (–ø—Ä–æ–±–ª–µ–º–∞ #4)
RUN apt-get update && \
    # –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –∏–∑ base image
    apt-get remove --purge -y \
    ros-${ROS_DISTRO}-builtin-interfaces \
    ros-${ROS_DISTRO}-rcutils \
    ros-${ROS_DISTRO}-rosidl-runtime-c \
    ros-${ROS_DISTRO}-rosidl-runtime-cpp \
    ros-${ROS_DISTRO}-rosidl-typesupport-c \
    ros-${ROS_DISTRO}-rosidl-typesupport-cpp \
    ros-${ROS_DISTRO}-rosidl-typesupport-fastrtps-c \
    ros-${ROS_DISTRO}-rosidl-typesupport-fastrtps-cpp 2>/dev/null || true && \
    # –¢–µ–ø–µ—Ä—å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å—ë –∑–∞–Ω–æ–≤–æ
    apt-get install -y \
    # ROS2 development tools (–¥–ª—è colcon build —Å custom messages)
    ros-dev-tools \
    # ROS2 –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    ros-${ROS_DISTRO}-std-msgs \
    ros-${ROS_DISTRO}-std-srvs \
    ros-${ROS_DISTRO}-sensor-msgs \
    ros-${ROS_DISTRO}-geometry-msgs \
    ros-${ROS_DISTRO}-nav-msgs \
    # ROS2 message generation (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –¥–ª—è builtin_interfaces)
    ros-${ROS_DISTRO}-rosidl-default-generators \
    ros-${ROS_DISTRO}-rosidl-default-runtime \
    # Runtime –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–∏—Å—Ç–æ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è)
    ros-${ROS_DISTRO}-builtin-interfaces \
    ros-${ROS_DISTRO}-rcutils \
    ros-${ROS_DISTRO}-rosidl-runtime-c \
    ros-${ROS_DISTRO}-rosidl-runtime-cpp \
    ros-${ROS_DISTRO}-rosidl-typesupport-c \
    ros-${ROS_DISTRO}-rosidl-typesupport-cpp \
    ros-${ROS_DISTRO}-rosidl-typesupport-fastrtps-c \
    ros-${ROS_DISTRO}-rosidl-typesupport-fastrtps-cpp \
    && rm -rf /var/lib/apt/lists/*

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –±–∏–±–ª–∏–æ—Ç–µ–∫ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
# –ò—Å–ø–æ–ª—å–∑—É–µ–º requirements.txt –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
# BuildKit cache mount –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –º–µ–∂–¥—É —Å–±–æ—Ä–∫–∞–º–∏
# –í–ê–ñ–ù–û: setuptools <80 —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å colcon-core –∏ antlr4-python3-runtime

# –ö–æ–ø–∏—Ä—É–µ–º requirements.txt –ü–ï–†–ï–î –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
COPY docker/vision/voice_assistant/requirements.txt /tmp/requirements.txt

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º pip, setuptools, wheel –∏ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π
# BuildKit cache mount —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –º–µ–∂–¥—É —Å–±–æ—Ä–∫–∞–º–∏
RUN --mount=type=cache,target=/root/.cache/pip,sharing=locked \
    pip3 install --no-cache-dir --upgrade pip "setuptools>=59.6.0,<68" wheel && \
    pip3 install -r /tmp/requirements.txt && \
    rm /tmp/requirements.txt

# –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
WORKDIR /ws
RUN mkdir -p src/rob_box_voice src/rob_box_animations

# ============================================================
# –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –°–õ–û–ï–í –î–õ–Ø –ö–ï–®–ò–†–û–í–ê–ù–ò–Ø (dependencies ‚Üí config ‚Üí code)
# ============================================================

# –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä—É–µ–º audio_common_msgs (—Ä–µ–¥–∫–æ –º–µ–Ω—è–µ—Ç—Å—è)
RUN cd /ws/src && \
    git clone -b ros2 --depth 1 https://github.com/ros-drivers/audio_common.git && \
    cd audio_common && \
    # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ audio_common_msgs, —É–¥–∞–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
    find . -maxdepth 1 -type d ! -name '.' ! -name '.git' ! -name 'audio_common_msgs' -exec rm -rf {} + && \
    echo "‚úÖ audio_common_msgs extracted from ros2 branch"

# –®–∞–≥ 2: –ö–æ–ø–∏—Ä—É–µ–º package.xml –¥–ª—è rosdep (–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–Ω—è—é—Ç—Å—è —Ä–µ–¥–∫–æ)
COPY src/rob_box_voice/package.xml /ws/src/rob_box_voice/
COPY src/rob_box_animations/package.xml /ws/src/rob_box_animations/
COPY src/rob_box_perception_msgs/package.xml /ws/src/rob_box_perception_msgs/

# –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ROS –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ rosdep
# –≠—Ç–æ—Ç —Å–ª–æ–π –∫–µ—à–∏—Ä—É–µ—Ç—Å—è –ø–æ–∫–∞ package.xml –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è
RUN . /opt/ros/${ROS_DISTRO}/setup.sh && \
    rosdep update && \
    rosdep install --from-paths src/rob_box_voice src/rob_box_animations src/rob_box_perception_msgs --ignore-src -r -y || true

# –®–∞–≥ 4: –ö–æ–ø–∏—Ä—É–µ–º setup.py –∏ CMakeLists.txt (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–∫–µ—Ç–∞ –º–µ–Ω—è–µ—Ç—Å—è —Ä–µ–¥–∫–æ)
COPY src/rob_box_voice/setup.py /ws/src/rob_box_voice/
COPY src/rob_box_voice/setup.cfg /ws/src/rob_box_voice/
COPY src/rob_box_animations/CMakeLists.txt /ws/src/rob_box_animations/
COPY src/rob_box_perception_msgs/CMakeLists.txt /ws/src/rob_box_perception_msgs/

# –®–∞–≥ 5: –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ —Ä–µ—Å—É—Ä—Å—ã
COPY src/rob_box_voice/resource /ws/src/rob_box_voice/resource
COPY sound_pack /ws/sound_pack

# –®–∞–≥ 6: –ö–æ–ø–∏—Ä—É–µ–º launch —Ñ–∞–π–ª—ã –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
COPY src/rob_box_voice/launch /ws/src/rob_box_voice/launch
COPY src/rob_box_voice/config /ws/src/rob_box_voice/config
COPY src/rob_box_voice/prompts /ws/src/rob_box_voice/prompts
COPY src/rob_box_animations/launch /ws/src/rob_box_animations/launch

# –®–∞–≥ 7: –ö–æ–ø–∏—Ä—É–µ–º message —Ñ–∞–π–ª—ã –¥–ª—è rob_box_perception_msgs
COPY src/rob_box_perception_msgs/msg /ws/src/rob_box_perception_msgs/msg

# –®–∞–≥ 8: –ö–æ–ø–∏—Ä—É–µ–º animations data
COPY src/rob_box_animations/animations /ws/src/rob_box_animations/animations

# –®–∞–≥ 9: –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ Python (–º–µ–Ω—è–µ—Ç—Å—è —á–∞—â–µ –≤—Å–µ–≥–æ - –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–ª–æ–π!)
COPY src/rob_box_voice/rob_box_voice /ws/src/rob_box_voice/rob_box_voice
COPY src/rob_box_animations/rob_box_animations /ws/src/rob_box_animations/rob_box_animations

# –®–∞–≥ 10: –ö–æ–ø–∏—Ä—É–µ–º scripts
COPY src/rob_box_voice/scripts /ws/src/rob_box_voice/scripts
COPY src/rob_box_animations/scripts /ws/src/rob_box_animations/scripts

# ============================================================
# –í–ù–ï–®–ù–ò–ï –ó–ê–í–ò–°–ò–ú–û–°–¢–ò (ReSpeaker drivers, models)
# ============================================================

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ReSpeaker –¥—Ä–∞–π–≤–µ—Ä–æ–≤ (usb_4_mic_array –∏ pixel_ring)
# –≠—Ç–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –º–µ–Ω—è—é—Ç—Å—è —Ä–µ–¥–∫–æ, –ø–æ—ç—Ç–æ–º—É —Å—Ç–∞–≤–∏–º –¥–æ —Å–±–æ—Ä–∫–∏ ROS –ø–∞–∫–µ—Ç–æ–≤
RUN cd /tmp && \
    git clone https://github.com/respeaker/usb_4_mic_array.git && \
    cd usb_4_mic_array && \
    pip3 install --no-cache-dir -r requirements.txt && \
    # –ö–æ–ø–∏—Ä—É–µ–º tuning.py –∏ dfu.py –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—É—Ç—å
    cp tuning.py /usr/local/bin/ && \
    cp dfu.py /usr/local/bin/ && \
    chmod +x /usr/local/bin/tuning.py /usr/local/bin/dfu.py && \
    cd /tmp && \
    git clone https://github.com/respeaker/pixel_ring.git && \
    cd pixel_ring && \
    python3 setup.py install && \
    cd / && rm -rf /tmp/usb_4_mic_array /tmp/pixel_ring

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ udev –ø—Ä–∞–≤–∏–ª –¥–ª—è ReSpeaker
RUN echo 'SUBSYSTEM=="usb", ATTR{idVendor}=="2886", ATTR{idProduct}=="0018", MODE="0666", GROUP="audio"' \
    > /etc/udev/rules.d/60-respeaker.rules

# –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ STT/TTS –º–æ–¥–µ–ª–µ–π (offline)
# –ú–æ–¥–µ–ª–∏ –±–æ–ª—å—à–∏–µ (145 MB) –∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è - –∫–µ—à–∏—Ä—É–µ–º
RUN mkdir -p /models && \
    # Vosk STT: Russian small model (45 MB, fast)
    wget -q -O /tmp/vosk-model.zip \
    https://alphacephei.com/vosk/models/vosk-model-small-ru-0.22.zip && \
    unzip -q /tmp/vosk-model.zip -d /models/ && \
    rm /tmp/vosk-model.zip && \
    # Silero TTS v4: Russian model (100 MB, neural TTS, 4 voices, SSML support)
    # –ì–æ–ª–æ—Å–∞: aidar (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –ú), baya (—Å–ø–æ–∫–æ–π–Ω—ã–π –ú), kseniya (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –ñ), xenia (—ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π –ñ)
    wget -q -O /models/silero_v4_ru.pt \
    https://models.silero.ai/models/tts/ru/v4_ru.pt && \
    echo "‚úÖ STT/TTS models downloaded: Vosk (45 MB) + Silero v4 (100 MB)"

# ============================================
# üöÄ –°–ë–û–†–ö–ê ROS2 –ü–ê–ö–ï–¢–û–í
# ============================================

# –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ CMAKE_LIBRARY_PATH –∏ CMAKE_FIND_ROOT_PATH,
# –∫–æ—Ç–æ—Ä—ã–µ –º–µ—à–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–æ–∏—Å–∫—É –±–∏–±–ª–∏–æ—Ç–µ–∫ —á–µ—Ä–µ–∑ CMake package config.
# Sourcing /opt/ros/humble/setup.sh –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É—Ç–µ–π.
# –ò—Å–ø–æ–ª—å–∑—É–µ–º --symlink-install –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è Python —Ñ–∞–π–ª–æ–≤.
RUN . /opt/ros/${ROS_DISTRO}/setup.sh && \
    colcon build \
    --packages-select audio_common_msgs rob_box_perception_msgs rob_box_voice rob_box_animations \
    --symlink-install \
    --cmake-args \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

# Source workspace
RUN echo "source /opt/ros/${ROS_DISTRO}/setup.bash" >> /root/.bashrc && \
    echo "source /ws/install/setup.bash" >> /root/.bashrc

# ROS2 –∏ Zenoh environment variables
ENV ROS_DOMAIN_ID=0
ENV RMW_IMPLEMENTATION=rmw_zenoh_cpp
ENV RUST_LOG=zenoh=info
ENV ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
ENV ZENOH_CONFIG=/config/shared/zenoh_session_config.json5

# –ê—É–¥–∏–æ environment variables
ENV AUDIODEV=hw:ArrayUAC10,0
ENV ALSA_CARD=ArrayUAC10

# –ü—É—Ç–∏ –∫ –¥–∞–Ω–Ω—ã–º
ENV SOUND_PACK_DIR=/ws/sound_pack
ENV TTS_CACHE_DIR=/config/voice/tts_cache

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –Ω–æ–¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD ros2 node list | grep -q "audio_node\|animation_player" || exit 1

# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
ENTRYPOINT ["/bin/bash", "-c", "source /ws/install/setup.bash && exec \"$@\"", "--"]

# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ startup script
CMD ["/scripts/start_voice_assistant.sh"]
