# Internal Dialogue Architecture v2.0

> **โ๏ธ ะะะะะะะะ:** ะญัะฐ ะดะพะบัะผะตะฝัะฐัะธั ัััะฐัะตะปะฐ. ะะบััะฐะปัะฝะฐั ะฟะพะปะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั:
> 
> **[INTERNAL_DIALOGUE_VOICE_ASSISTANT.md](INTERNAL_DIALOGUE_VOICE_ASSISTANT.md)**
>
> ะะพะฒัะน ะดะพะบัะผะตะฝั ะฒะบะปััะฐะตั:
> - Event-driven ะฐััะธัะตะบัััะฐ ั Context Aggregator (MPC lite)
> - ะกัะผะผะฐัะธะทะฐัะธั ะฟะพ ัะธะฟะฐะผ: speech/vision/system
> - ะะฝัะตะณัะฐัะธั ั Voice Assistant ะธ urgent hook
> - ะะพะปะฝัะต ะดะธะฐะณัะฐะผะผั ะธ ะฟัะธะผะตัั ะบะพะดะฐ

---

# Internal Dialogue Architecture v2.0 (ะฃะกะขะะะะะ)

## ๐๏ธ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PERCEPTION LAYER (Context Aggregator - MPC lite)           โ
โ  ะกะพะฑะธัะฐะตั ะดะฐะฝะฝัะต โ ะฟัะฑะปะธะบัะตั ัะพะฑััะธั                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ /perception/context_update (PerceptionEvent)
         โ /perception/user_speech (String)
         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  REFLECTION LAYER (Internal Dialogue Agent)                  โ
โ  Event-Driven: ัะพะฑััะธั โ ะดัะผะฐะตั โ ัะตัั                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ /reflection/internal_thought (String)
         โ /voice/tts/request (String)
         โ
    Voice Assistant
```

## ๐ฆ ะะพะผะฟะพะฝะตะฝัั

### 1. context_aggregator_node (MPC lite)
**ะะพะปั:** ะกะฑะพััะธะบ ะดะฐะฝะฝัั ะฒะพัะฟัะธััะธั

**ะะพะดะฟะธััะฒะฐะตััั ะฝะฐ:**
- `/perception/vision_context` - vision processing
- `/rtabmap/localization_pose` - ะฟะพะทะธัะธั ะฝะฐ ะบะฐััะต
- `/odom` - ะพะดะพะผะตััะธั
- `/device/snapshot` - ัะตะฝัะพัั ESP32
- `/apriltag/detections` - AprilTag ะผะฐัะบะตัั
- `/rosout` - ัะธััะตะผะฝัะต ะปะพะณะธ (ERROR/WARN)
- `/voice/stt/result` - ะฒัะพะดััะฐั ัะตัั ะฟะพะปัะทะพะฒะฐัะตะปั

**ะัะฑะปะธะบัะตั:**
- `/perception/context_update` (PerceptionEvent) - ะฐะณัะตะณะธัะพะฒะฐะฝะฝะพะต ัะพะฑััะธะต
- `/perception/user_speech` (String) - ััะฐะฝะทะธั STT ะดะปั ัะตัะปะตะบัะธะธ

**ะัะพะฑะตะฝะฝะพััะธ:**
- **ะะ ะดัะผะฐะตั**, **ะะ ะฟัะธะฝะธะผะฐะตั ัะตัะตะฝะธะน**
- ะขะพะปัะบะพ ัะฑะพั ะธ ะฟัะฑะปะธะบะฐัะธั
- ะงะฐััะพัะฐ ัะพะฑััะธะน: 2 Hz (configurable)
- ะะพะฝะธัะพัะธะฝะณ ะทะดะพัะพะฒัั ัะธััะตะผั
- ะะพัะพัะบะฐั ะฟะฐะผััั ัะพะฑััะธะน (60 ัะตะบ)

### 2. reflection_node (Internal Dialogue Agent v2.0)
**ะะพะปั:** ะะฝัััะตะฝะฝะธะน ะดะธะฐะปะพะณ ัะพะฑะพัะฐ

**ะะพะดะฟะธััะฒะฐะตััั ะฝะฐ:**
- `/perception/context_update` (PerceptionEvent)
- `/perception/user_speech` (String)
- `/voice/dialogue/response` (String) - ะดะปั ะพััะปะตะถะธะฒะฐะฝะธั ะดะธะฐะปะพะณะฐ

**ะัะฑะปะธะบัะตั:**
- `/reflection/internal_thought` (String) - ะฒะฝัััะตะฝะฝะธะต ะผััะปะธ
- `/voice/tts/request` (String) - ัะตัั ัะพะฑะพัะฐ

**ะัะพะฑะตะฝะฝะพััะธ:**
- **Event-Driven**: ัะฐะทะผััะปัะตั ะฟัะธ ะฟะพะปััะตะฝะธะธ ัะพะฑััะธั (ะฝะต ะฟะพ ัะฐะนะผะตัั!)
- **Hook ะดะปั ััะพัะฝัั ะพัะฒะตัะพะฒ**: ะดะตัะตะบัะพั ะปะธัะฝัั ะฒะพะฟัะพัะพะฒ
  * "ะบะฐะบ ะดะตะปะฐ?", "ะบะฐะบ ัั?", "ััะพ ั ัะตะฑั?" โ ะฑัััััะน ะพัะฒะตั (<2 ัะตะบ)
  * Interrupt ัะธะบะปะฐ ัะฐะทะผััะปะตะฝะธะน
  * ะกะฟะตัะธะฐะปัะฝัะน prompt ะดะปั ะบะพัะพัะบะธั ะพัะฒะตัะพะฒ
- DeepSeek API ะดะปั ะณะตะฝะตัะฐัะธะธ ะผััะปะตะน
- ะฃะฟัะฐะฒะปะตะฝะธะต ะดะธะฐะปะพะณะพะผ (ัะฐะนะผ-ะฐัั 10 ัะตะบ)

## ๐ ะะพัะพะบ ะดะฐะฝะฝัั

### ะะฑััะฝะพะต ัะฐะทะผััะปะตะฝะธะต:
```
1. context_aggregator ะฟะพะปััะฐะตั ะดะฐะฝะฝัะต ัะพ ะฒัะตั ัะพะฟะธะบะพะฒ
2. ะะณัะตะณะธััะตั ะฒ PerceptionEvent (ะบะฐะถะดัะต 0.5 ัะตะบ)
3. ะัะฑะปะธะบัะตั /perception/context_update
4. reflection_node ะฟะพะปััะฐะตั ัะพะฑััะธะต
5. ะัะพะฒะตััะตั: ะดะธะฐะปะพะณ ะฐะบัะธะฒะตะฝ?
   - ะะฐ โ ะถะดัั ัะฐะนะผ-ะฐััะฐ
   - ะะตั โ ะดัะผะฐะตั
6. DeepSeek ะฐะฝะฐะปะธะทะธััะตั ะบะพะฝัะตะบัั
7. ะะตะฝะตัะธััะตั ะผััะปั + ัะตัะตะฝะธะต ะณะพะฒะพัะธัั ะธะปะธ ะฝะตั
8. ะัะฑะปะธะบัะตั thought ะธ/ะธะปะธ speech
```

### ะกัะพัะฝัะน ะพัะฒะตั ะฝะฐ ะปะธัะฝัะน ะฒะพะฟัะพั:
```
1. ะะพะปัะทะพะฒะฐัะตะปั: "ะะพะฑะพั, ะบะฐะบ ั ัะตะฑั ะดะตะปะฐ?"
2. STT โ /voice/stt/result
3. context_aggregator โ ััะฐะฝะทะธั โ /perception/user_speech
4. reflection_node ะฟะพะปััะฐะตั ัะตัั
5. ะะตัะตะบัะพั: ััะพ ะปะธัะฝัะน ะฒะพะฟัะพั! ๐ฏ
6. ะฃััะฐะฝะฐะฒะปะธะฒะฐะตั pending_user_speech
7. ะัะธ ัะปะตะดัััะตะผ context_update (ะผะฐะบั 0.5 ัะตะบ):
   - Interrupt ะพะฑััะฝะพะณะพ ัะธะบะปะฐ
   - ะัะฐัะบะธะน prompt ะดะปั ะฑััััะพะณะพ ะพัะฒะตัะฐ
   - DeepSeek ะณะตะฝะตัะธััะตั ะบะพัะพัะบะธะน ะพัะฒะตั (1-2 ะฟัะตะดะปะพะถะตะฝะธั)
   - ะัะฑะปะธะบัะตั speech ะฝะตะผะตะดะปะตะฝะฝะพ
8. ะัะตะผั ะพัะฒะตัะฐ: <2 ัะตะบัะฝะดั
```

## ๐ฏ ะะตัะตะบัะพั ะปะธัะฝัั ะฒะพะฟัะพัะพะฒ

Regex ะฟะฐััะตัะฝั (case-insensitive):
- `\bะบะฐะบ\s+(ั\s+ัะตะฑั\s+)?ะดะตะปะฐ\b`
- `\bะบะฐะบ\s+ัั\b`
- `\bััะพ\s+ั\s+ัะตะฑั\b`
- `\bะบะฐะบ\s+ัะฒะพั?\s+(ะฝะฐัััะพะตะฝะธะต|ัะฐะผะพััะฒััะฒะธะต)\b`
- `\bััะพ\s+(ะดะตะปะฐะตัั|ะฟัะพะธััะพะดะธั)\b`
- `\bะบะฐะบ\s+ัะตะฑั\s+ััะฒััะฒัะตัั\b`

## ๐ Message: PerceptionEvent

```
builtin_interfaces/Time stamp
string vision_context           # JSON ะพั vision processing
geometry_msgs/Pose pose          # ะะพะทะธัะธั ะฝะฐ ะบะฐััะต
geometry_msgs/Twist velocity     # ะกะบะพัะพััั ะดะฒะธะถะตะฝะธั
bool is_moving                   # ะะพะฑะพั ะดะฒะธะถะตััั?
float32 battery_voltage          # ะะฐัะฐัะตั
float32 temperature              # ะขะตะผะฟะตัะฐัััะฐ
int32[] apriltag_ids             # ะะฑะฝะฐััะถะตะฝะฝัะต ะผะฐัะบะตัั
string system_health_status      # "healthy", "degraded", "critical"
string[] health_issues           # ะกะฟะธัะพะบ ะฟัะพะฑะปะตะผ
string memory_summary            # ะัะฐัะบะพะต ัะตะทัะผะต ะฟะฐะผััะธ
```

## ๐ ะะฐะฟััะบ

### ะะพะบะฐะปัะฝะพ (ั vision stub):
```bash
ros2 launch rob_box_perception internal_dialogue.launch.py
```

ะะฐะฟััะบะฐะตั:
- vision_stub_node (ะทะฐะณะปััะบะฐ ะบะฐะผะตัั)
- context_aggregator
- reflection_node

### Docker (production):
```bash
docker compose up perception
```

ะะฐะฟััะบะฐะตั:
- context_aggregator
- reflection_node

## โ๏ธ ะะฐัะฐะผะตััั

### context_aggregator:
- `publish_rate` (float, default: 2.0) - ะงะฐััะพัะฐ ัะพะฑััะธะน (Hz)
- `memory_window` (int, default: 60) - ะะบะฝะพ ะฟะฐะผััะธ (ัะตะบ)

### reflection_node:
- `dialogue_timeout` (float, default: 10.0) - ะขะฐะนะผ-ะฐัั ะดะธะฐะปะพะณะฐ (ัะตะบ)
- `enable_speech` (bool, default: true) - ะะบะปััะธัั ัะตัั
- `system_prompt_file` (string, default: reflection_prompt.txt)
- `urgent_response_timeout` (float, default: 2.0) - ะขะฐะนะผ-ะฐัั ััะพัะฝะพะณะพ ะพัะฒะตัะฐ (ัะตะบ)

### Environment variables (Docker):
```bash
DIALOGUE_TIMEOUT=10.0
URGENT_RESPONSE_TIMEOUT=2.0
ENABLE_SPEECH=true
CONTEXT_PUBLISH_RATE=2.0
MEMORY_WINDOW=60
DEEPSEEK_API_KEY=sk-xxx  # Required!
```

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

### ะัะพะฒะตัะธัั ัะพะฟะธะบะธ:
```bash
ros2 topic list | grep perception
# /perception/context_update
# /perception/user_speech

ros2 topic hz /perception/context_update
# average rate: 2.000
```

### ะกะผะพััะตัั ัะพะฑััะธั:
```bash
ros2 topic echo /perception/context_update
```

### ะกะผะพััะตัั ะผััะปะธ:
```bash
ros2 topic echo /reflection/internal_thought
```

### ะขะตัั ััะพัะฝะพะณะพ ะพัะฒะตัะฐ:
```bash
# ะัะฑะปะธะบัะตะผ ะปะธัะฝัะน ะฒะพะฟัะพั
ros2 topic pub --once /voice/stt/result std_msgs/String "data: 'ะะพะฑะพั ะบะฐะบ ั ัะตะฑั ะดะตะปะฐ'"

# ะกะผะพััะธะผ ะปะพะณะธ (ะดะพะปะถะตะฝ ะฑััั ะฑัััััะน ะพัะฒะตั)
# ๐ฏ ะะฑะฝะฐััะถะตะฝ ะปะธัะฝัะน ะฒะพะฟัะพั โ ััะพัะฝัะน ะพัะฒะตั
# โก ะกัะพัะฝัะน ะพัะฒะตั ะฝะฐ ะปะธัะฝัะน ะฒะพะฟัะพั
# ๐ฃ๏ธ  ะะพะฒะพัั: "ะฃ ะผะตะฝั ะฒัั ะพัะปะธัะฝะพ, ะณะพัะพะฒ ะบ ัะฐะฑะพัะต!"
```

## ๐ ะัะตะธะผััะตััะฒะฐ ะฝะพะฒะพะน ะฐััะธัะตะบัััั

โ **ะะฐะทะดะตะปะตะฝะธะต ะพัะฒะตัััะฒะตะฝะฝะพััะธ**: ัะฑะพั ะดะฐะฝะฝัั โ ัะฐะทะผััะปะตะฝะธั  
โ **Event-Driven**: ะฝะตั ะฟััััั ัะธะบะปะพะฒ, ัะบะพะฝะพะผะธั CPU  
โ **ะะฐัััะฐะฑะธััะตะผะพััั**: ะปะตะณะบะพ ะดะพะฑะฐะฒะธัั ะฝะพะฒัะต ะธััะพัะฝะธะบะธ ะฒ aggregator  
โ **ะกัะพัะฝัะต ะพัะฒะตัั**: hook ะดะปั ะปะธัะฝัั ะฒะพะฟัะพัะพะฒ (<2 ัะตะบ)  
โ **Unified events**: ะฒัะต ะดะฐะฝะฝัะต ะฒ ะพะดะฝะพะผ PerceptionEvent  
โ **ะขะตััะธััะตะผะพััั**: ะผะพะถะฝะพ ัะตััะธัะพะฒะฐัั ะฝะพะดั ะฝะตะทะฐะฒะธัะธะผะพ  

## ๐ง ะะฐะทัะฐะฑะพัะบะฐ

### ะะพะฑะฐะฒะธัั ะฝะพะฒัะน ะธััะพัะฝะธะบ ะดะฐะฝะฝัั:
1. ะัะบัััั `context_aggregator_node.py`
2. ะะพะฑะฐะฒะธัั subscription ะฝะฐ ะฝะพะฒัะน ัะพะฟะธะบ
3. ะะฑะฝะพะฒะธัั callback ะดะปั ัะพััะฐะฝะตะฝะธั ะดะฐะฝะฝัั
4. ะะฑะฝะพะฒะธัั `publish_event()` ะดะปั ะฒะบะปััะตะฝะธั ะฒ PerceptionEvent
5. (ะะฟัะธะพะฝะฐะปัะฝะพ) ะะฑะฝะพะฒะธัั `PerceptionEvent.msg` ะตัะปะธ ะฝัะถะฝั ะฝะพะฒัะต ะฟะพะปั

### ะะพะฑะฐะฒะธัั ะฝะพะฒัะน ะฟะฐััะตัะฝ ะปะธัะฝะพะณะพ ะฒะพะฟัะพัะฐ:
1. ะัะบัััั `reflection_node.py`
2. ะะฐะนัะธ ะผะตัะพะด `_is_personal_question()`
3. ะะพะฑะฐะฒะธัั regex ะฟะฐััะตัะฝ ะฒ ัะฟะธัะพะบ `personal_patterns`

## ๐ ะััะพัะธั ะฒะตััะธะน

**v2.0** (current) - Event-Driven ะฐััะธัะตะบัััะฐ
- ะะฐะทะดะตะปะตะฝะธะต ะฝะฐ context_aggregator + reflection_node
- Hook ะดะปั ััะพัะฝัั ะพัะฒะตัะพะฒ
- PerceptionEvent message

**v1.0** - Monolithic ะฐััะธัะตะบัััะฐ
- ะัั ะฒ ะพะดะฝะพะน ะฝะพะดะต (reflection_node_old.py)
- Timer-based ัะฐะทะผััะปะตะฝะธั
- ะััะผัะต ะฟะพะดะฟะธัะบะธ ะฝะฐ ะฒัะต ัะพะฟะธะบะธ
