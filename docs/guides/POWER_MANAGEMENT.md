# Управление питанием Raspberry Pi 5

## Обзор проблемы

Raspberry Pi 5 имеет строгие требования к питанию и активно контролирует источник питания. При недостаточном токе (менее 5A) система автоматически ограничивает производительность и USB-порты, что критично для робототехники.

## Режимы питания

### 1. Стандартное USB-A → USB-C подключение
- **Обнаруженный ток**: 900mA (максимум для USB 3.0)
- **Ограничения**: Сильное троттлинг системы, USB ограничен 600mA
- **Применение**: ❌ Не рекомендуется для роботов

### 2. USB-C Power Delivery (PD)
- **Обнаруженный ток**: Зависит от переговоров PD (обычно 3000mA на 5V)
- **Ограничения**: USB ограничен 600mA, возможны замедления системы
- **Применение**: ⚠️ Требует настройки для робототехники

### 3. Питание через 5V пины (GPIO)
- **Обнаруженный ток**: Unknown 3000mA (предположение системы)
- **Ограничения**: USB ограничен 600mA, возможны замедления системы
- **Применение**: ⚠️ Требует настройки, но стандартный метод для роботов

### 4. Официальный адаптер Raspberry Pi
- **Характеристики**: 5.1V @ 5A (25.5W)
- **Обнаруженный ток**: 5000mA
- **Ограничения**: Нет ограничений, USB до 1600mA
- **Применение**: ✅ Идеально для настольной работы, ❌ не подходит для роботов

## Симптомы недостаточного питания

1. **Уведомление в GUI**: "Ваш блок питания менее 5A, питание периферии ограничено"
2. **Медленный запуск приложений**: Терминал может запускаться 5-10 секунд
3. **Ограничение USB**: Максимум 600mA вместо 1600mA на все порты
4. **Возможная нестабильность**: При высокой нагрузке возможны сбои SD-карты

## Решения для робототехники

### Решение 1: Программная настройка (базовая)

#### Шаг 1: Разрешить полный ток USB (если питание позволяет)

Отредактировать `/boot/firmware/config.txt`:

```bash
sudo nano /boot/firmware/config.txt
```

Добавить в конец файла:

```ini
# Разрешить полный ток USB (1600mA вместо 600mA)
# ВНИМАНИЕ: Используйте только если блок питания может обеспечить достаточный ток!
usb_max_current_enable=1
```

**Предупреждение**: Используйте только если ваш источник питания может выдать минимум 3-4A стабильно!

#### Шаг 2: Настройка EEPROM (продвинутая)

Сообщить загрузчику о реальной мощности питания:

```bash
# Редактировать конфигурацию EEPROM
sudo rpi-eeprom-config --edit
```

Добавить строку:

```ini
# Для питания через GPIO 5V пины от батареи/стабилизатора с током 5A
PSU_MAX_CURRENT=5000

# Или для менее мощного источника (например, 4A)
# PSU_MAX_CURRENT=4000
```

После сохранения изменения применятся при следующей загрузке.

**Рекомендации по значению**:
- `PSU_MAX_CURRENT=5000` - если у вас стабилизатор на 5A или мощнее
- `PSU_MAX_CURRENT=4000` - для стабилизаторов 4A (может быть уведомление, но система работает)
- `PSU_MAX_CURRENT=3000` - минимум для стабильной работы без периферии

### Решение 2: Аппаратное решение (рекомендуется для роботов)

#### 52Pi PD Power Expansion Board (HAT)

**Характеристики**:
- Вход: USB-C PD 15V @ 3A (45W) или DC 9-24V
- Выход Pi: 5.15V @ 5A (25W) через USB-C
- Дополнительный выход: 5V @ 3A через разъем
- Поддержка: 3-5S LiPo, Li-Ion 18650, аккумуляторы электроинструментов

**Преимущества**:
- ✅ Pi всегда видит "официальное" питание 5000mA
- ✅ Стабильное напряжение 5.15V компенсирует просадки
- ✅ Универсальность: USB-C PD на столе, батарея на роботе
- ✅ Дополнительный выход 5V для сенсоров и периферии
- ✅ Кнопка включения/выключения (опционально)

**Недостатки**:
- ❌ Дополнительные затраты (~$20-30)
- ❌ Занимает место (можно монтировать сверху Pi или отдельно)

**Подключение**:
1. HAT на Pi: Через USB-C выход HAT в USB-C порт Pi
2. Питание HAT: 
   - Для настольной работы: USB-C PD 15V адаптер
   - Для робота: DC разъем от батареи 9-24V (3S-5S LiPo)
3. Дополнительная периферия: 5V выход через разъем/пины

**Ссылка**: Искать "52Pi PD Power Expansion Board" или аналоги

## Мониторинг питания

### Проверка текущего режима питания

```bash
# Проверить лимит USB тока (0 = 600mA, 1 = 1600mA)
vcgencmd get_config usb_max_current_enable

# Проверить троттлинг (биты показывают undervoltage, frequency cap и т.д.)
vcgencmd get_throttled

# Текущее напряжение и частота
vcgencmd measure_volts
vcgencmd measure_clock arm
```

### Диагностический экран загрузчика

Для просмотра информации о питании без загрузки ОС:
1. Выключить Pi
2. Вынуть SD-карту
3. Включить Pi
4. Появится диагностический экран с информацией о питании

**Примеры вывода**:
- `USB 900mA` - стандартный USB-A
- `PD 3000mA` - USB-C Power Delivery на 5V
- `Unknown 3000mA` - питание через GPIO
- `Official 5000mA` - официальный адаптер или правильно настроенный HAT

## Рекомендации для rob_box_project

### Текущая конфигурация

В нашем проекте используется:
- **Main Pi** (10.1.1.20): Вычислительная нагрузка (RTAB-Map, robot_state_publisher)
- **Vision Pi** (10.1.1.21): Сенсоры (OAK-D, LSLIDAR N10 через USB)

### Рекомендуемая конфигурация питания

#### Main Pi
- **Потребление**: ~2-3A под нагрузкой SLAM
- **USB нагрузка**: Минимальная (Ethernet, WiFi dongle?)
- **Решение**: Питание через GPIO от 5V стабилизатора 5A + `PSU_MAX_CURRENT=5000` в EEPROM

#### Vision Pi
- **Потребление**: ~1.5-2A базовое
- **USB нагрузка**: OAK-D (~500-800mA), LSLIDAR (~500mA через /dev/ttyACM0)
- **Суммарно**: До 3-3.5A пиковое
- **Решение**: 
  - **Оптимально**: 52Pi HAT с питанием от основной батареи 12-24V
  - **Альтернатива**: Мощный 5V стабилизатор 5A + `PSU_MAX_CURRENT=5000` + `usb_max_current_enable=1`

### Расчет батареи

Для робота с двумя Raspberry Pi 5:

```
Main Pi: 3A @ 5V = 15W
Vision Pi: 3.5A @ 5V = 17.5W
Итого Pi: 32.5W

+ Моторы: зависит от конфигурации
+ Прочее: LED матрица, сервоприводы и т.д.

Пример с 4S LiPo (14.8V номинал):
5000mAh батарея = 5A * 14.8V = 74Wh
Только Pi потребляют: 32.5W
Время работы (только Pi): ~2.3 часа
Реальное время с моторами: ~1-1.5 часа
```

## Диагностика проблем питания

### Проблема: Медленная работа системы

**Проверка**:
```bash
vcgencmd get_config usb_max_current_enable
vcgencmd get_throttled
```

Если `get_throttled` возвращает не `0x0`, расшифровка битов:
- Бит 0: Undervoltage detected (напряжение ниже 4.63V)
- Бит 1: Arm frequency capped (частота ограничена)
- Бит 2: Currently throttled (троттлинг активен)
- Бит 3: Soft temperature limit (температурное ограничение)
- Биты 16-19: Те же проблемы, но в прошлом (с момента загрузки)

**Решение**: Улучшить питание (см. Решения выше)

### Проблема: USB устройства не работают

**Проверка**:
```bash
# Проверить лимит USB
vcgencmd get_config usb_max_current_enable

# Посмотреть USB устройства и их потребление
lsusb
dmesg | grep -i usb
```

**Решение**: 
1. Включить `usb_max_current_enable=1` в config.txt (если питание позволяет)
2. Использовать powered USB hub для мощных устройств
3. Рассмотреть 52Pi HAT для надежного питания

### Проблема: SD-карта повреждается

**Причина**: Скачки напряжения при недостаточном питании

**Решение**:
1. **Срочно**: Проверить и улучшить питание
2. Использовать качественные SD-карты (Samsung PRO Endurance, SanDisk MAX Endurance)
3. Минимизировать запись на SD (логи в RAM, данные на USB-накопитель)

## Полезные команды

```bash
# === Информация о питании ===
vcgencmd get_config usb_max_current_enable  # USB лимит (0/1)
vcgencmd get_throttled                       # История троттлинга
vcgencmd measure_volts                       # Текущее напряжение
vcgencmd measure_temp                        # Температура CPU

# === Информация о системе ===
vcgencmd measure_clock arm                   # Частота CPU
vcgencmd get_config arm_freq                 # Настроенная частота
cat /sys/class/thermal/thermal_zone0/temp    # Температура (милиградусы)

# === USB устройства ===
lsusb                                        # Список USB устройств
lsusb -t                                     # USB дерево (с хабами)
cat /sys/kernel/debug/usb/devices            # Детальная информация USB (требует root)

# === Питание USB портов ===
# Для каждого USB порта можно проверить ток (если доступно):
cat /sys/bus/usb/devices/*/power/current_now 2>/dev/null

# === Редактирование конфигурации ===
sudo nano /boot/firmware/config.txt          # Конфиг ОС (usb_max_current_enable)
sudo rpi-eeprom-config --edit                # Конфиг EEPROM (PSU_MAX_CURRENT)
sudo rpi-eeprom-config                       # Просмотр текущей конфигурации EEPROM

# === Обновление EEPROM ===
sudo rpi-eeprom-update                       # Проверить версию
sudo rpi-eeprom-update -a                    # Обновить если доступно
```

## Ссылки

- [Официальная документация Raspberry Pi: Power Supply](https://www.raspberrypi.com/documentation/computers/raspberry-pi.html#power-supply)
- [52Pi PD Power Expansion Board](https://wiki.52pi.com/index.php?title=EP-0177) (или поиск на AliExpress/Amazon)
- [Форум Raspberry Pi: Power issues](https://forums.raspberrypi.com/)
- [Источник видео: YouTube - Powering Raspberry Pi 5 for Robotics](https://www.youtube.com/watch?v=VIDEO_ID)

## История изменений

- **2025-10-10**: Создана документация на основе анализа питания Raspberry Pi 5 для робототехники
