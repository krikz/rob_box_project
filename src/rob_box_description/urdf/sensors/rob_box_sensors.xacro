<?xml version="1.0"?>
<!-- 
  rob_box_sensors.xacro
  
  Определение сенсоров Rob Box:
  - LSLIDAR N10 (2D LiDAR)
  - OAK-D-Lite (RGB + Stereo Depth)
  - Raspberry Pi Camera (направлена вверх)
-->
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">

  <!-- ═══════════════════════════════════════════════════════════════ -->
  <!-- LSLIDAR N10 - 2D LiDAR                                          -->
  <!-- ═══════════════════════════════════════════════════════════════ -->
  <xacro:macro name="lslidar_n10" params="parent_link xyz:='0 0 0' rpy:='0 0 0'">
    <link name="lslidar_n10_link">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <cylinder radius="0.026" length="0.0361"/>
        </geometry>
        <material name="black">
          <color rgba="0.1 0.1 0.1 1"/>
        </material>
      </visual>
      
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <cylinder radius="0.026" length="0.0361"/>
        </geometry>
      </collision>
      
      <inertial>
        <mass value="0.18"/>  <!-- ~180g -->
        <origin xyz="0 0 0"/>
        <inertia ixx="0.0001" ixy="0" ixz="0" 
                 iyy="0.0001" iyz="0" 
                 izz="0.0001"/>
      </inertial>
    </link>

    <joint name="lslidar_n10_joint" type="fixed">
      <parent link="${parent_link}"/>
      <child link="lslidar_n10_link"/>
      <origin xyz="${xyz}" rpy="${rpy}"/>
    </joint>

    <!-- Frame для scan data (обычно совпадает с link) -->
    <link name="laser_frame"/>
    <joint name="laser_frame_joint" type="fixed">
      <parent link="lslidar_n10_link"/>
      <child link="laser_frame"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
    </joint>
  </xacro:macro>

  <!-- ═══════════════════════════════════════════════════════════════ -->
  <!-- OAK-D-Lite - RGB + Stereo Depth Camera                          -->
  <!-- ═══════════════════════════════════════════════════════════════ -->
  <xacro:macro name="oak_d_lite" params="parent_link xyz:='0 0 0' rpy:='0 0 0'">
    <!-- Main camera body -->
    <link name="oak_d_lite_link">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <box size="0.092 0.028 0.017"/>  <!-- 92x28x17mm -->
        </geometry>
        <material name="dark_gray">
          <color rgba="0.3 0.3 0.3 1"/>
        </material>
      </visual>
      
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <box size="0.092 0.028 0.017"/>
        </geometry>
      </collision>
      
      <inertial>
        <mass value="0.061"/>  <!-- 61g -->
        <origin xyz="0 0 0"/>
        <inertia ixx="0.00001" ixy="0" ixz="0" 
                 iyy="0.00001" iyz="0" 
                 izz="0.00001"/>
      </inertial>
    </link>

    <joint name="oak_d_lite_joint" type="fixed">
      <parent link="${parent_link}"/>
      <child link="oak_d_lite_link"/>
      <origin xyz="${xyz}" rpy="${rpy}"/>
    </joint>

    <!-- RGB camera optical frame -->
    <link name="oak_rgb_camera_optical_frame"/>
    <joint name="oak_rgb_camera_optical_joint" type="fixed">
      <parent link="oak_d_lite_link"/>
      <child link="oak_rgb_camera_optical_frame"/>
      <!-- Optical frame: x-right, y-down, z-forward -->
      <origin xyz="0 0 0" rpy="${-pi/2} 0 ${-pi/2}"/>
    </joint>

    <!-- Left stereo camera -->
    <link name="oak_left_camera_optical_frame"/>
    <joint name="oak_left_camera_optical_joint" type="fixed">
      <parent link="oak_d_lite_link"/>
      <child link="oak_left_camera_optical_frame"/>
      <origin xyz="0 0.0375 0" rpy="${-pi/2} 0 ${-pi/2}"/>  <!-- 7.5cm baseline -->
    </joint>

    <!-- Right stereo camera -->
    <link name="oak_right_camera_optical_frame"/>
    <joint name="oak_right_camera_optical_joint" type="fixed">
      <parent link="oak_d_lite_link"/>
      <child link="oak_right_camera_optical_frame"/>
      <origin xyz="0 -0.0375 0" rpy="${-pi/2} 0 ${-pi/2}"/>
    </joint>
  </xacro:macro>

  <!-- ═══════════════════════════════════════════════════════════════ -->
  <!-- Raspberry Pi Camera - Ceiling Navigation                        -->
  <!-- Направлена вверх для ceiling-based локализации                  -->
  <!-- ═══════════════════════════════════════════════════════════════ -->
  <xacro:macro name="rpi_camera_ceiling" params="parent_link xyz:='0 0 0' rpy:='0 0 0'">
    <link name="rpi_camera_link">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <box size="0.025 0.024 0.009"/>  <!-- 25x24x9mm -->
        </geometry>
        <material name="green">
          <color rgba="0.1 0.6 0.1 1"/>
        </material>
      </visual>
      
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <box size="0.025 0.024 0.009"/>
        </geometry>
      </collision>
      
      <inertial>
        <mass value="0.003"/>  <!-- 3g -->
        <origin xyz="0 0 0"/>
        <inertia ixx="0.000001" ixy="0" ixz="0" 
                 iyy="0.000001" iyz="0" 
                 izz="0.000001"/>
      </inertial>
    </link>

    <joint name="rpi_camera_joint" type="fixed">
      <parent link="${parent_link}"/>
      <child link="rpi_camera_link"/>
      <origin xyz="${xyz}" rpy="${rpy}"/>
    </joint>

    <!-- Camera optical frame - направлена ВВЕРХ (pitch = 90°) -->
    <link name="rpi_camera_optical_frame"/>
    <joint name="rpi_camera_optical_joint" type="fixed">
      <parent link="rpi_camera_link"/>
      <child link="rpi_camera_optical_frame"/>
      <!-- Поворот: смотрит вверх (z вверх → y вверх в optical frame) -->
      <origin xyz="0 0 0" rpy="${-pi/2} 0 ${-pi/2}"/>
    </joint>
  </xacro:macro>

  <!-- ═══════════════════════════════════════════════════════════════ -->
  <!-- AprilTag Detector (виртуальный сенсор)                          -->
  <!-- Использует данные от камер для детекции маркеров               -->
  <!-- ═══════════════════════════════════════════════════════════════ -->
  <link name="apriltag_detector"/>
  <joint name="apriltag_detector_joint" type="fixed">
    <parent link="base_link"/>
    <child link="apriltag_detector"/>
    <origin xyz="0 0 0" rpy="0 0 0"/>
  </joint>

</robot>
