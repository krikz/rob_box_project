<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="rob_box">

  <!-- ═══════════════════════════════════════════════════════════════ -->
  <!-- XACRO Properties - Параметры из Fusion 360 -->
  <!-- ═══════════════════════════════════════════════════════════════ -->
  
  <!-- Геометрия робота (rocker-bogie) -->
  <xacro:property name="wheelbase" value="0.390" />  <!-- 390мм база (left↔right по X) -->
  <xacro:property name="track" value="0.289" />      <!-- 289мм колея (front↔rear по Y) -->
  <xacro:property name="wheel_radius" value="0.115" /> <!-- 115мм радиус колеса -->
  <xacro:property name="wheel_width" value="0.075" />  <!-- 75мм ширина колеса -->
  
  <!-- Координаты колес (из Fusion 360 URDF) -->
  <xacro:property name="wheel_rear_left_x" value="0.195" />
  <xacro:property name="wheel_rear_left_y" value="0.143797" />
  <xacro:property name="wheel_rear_left_z" value="0.028767" />
  
  <xacro:property name="wheel_front_left_x" value="0.195" />
  <xacro:property name="wheel_front_left_y" value="-0.145731" />
  <xacro:property name="wheel_front_left_z" value="0.0289" />
  
  <xacro:property name="wheel_front_right_x" value="-0.195967" />
  <xacro:property name="wheel_front_right_y" value="-0.144669" />
  <xacro:property name="wheel_front_right_z" value="0.0289" />
  
  <xacro:property name="wheel_rear_right_x" value="-0.195" />
  <xacro:property name="wheel_rear_right_y" value="0.143797" />
  <xacro:property name="wheel_rear_right_z" value="0.028767" />
  
  <!-- Координаты сенсоров -->
  <xacro:property name="lidar_x" value="-0.000331" />
  <xacro:property name="lidar_y" value="0.170806" />
  <xacro:property name="lidar_z" value="0.4765" />
  
  <xacro:property name="oak_d_x" value="-0.000238" />
  <xacro:property name="oak_d_y" value="0.115772" />
  <xacro:property name="oak_d_z" value="0.4595" />
  
  <xacro:property name="rpi_cam_x" value="0.065" />
  <xacro:property name="rpi_cam_y" value="0.170663" />
  <xacro:property name="rpi_cam_z" value="0.4615" />
  
  <!-- Математические константы -->
  <xacro:property name="M_PI" value="3.14159265359" />
  
  <!-- ═══════════════════════════════════════════════════════════════ -->
  <!-- Включаем дополнительные файлы -->
  <!-- ═══════════════════════════════════════════════════════════════ -->
  
  <!-- Материалы с крутыми текстурами -->
  <xacro:include filename="$(find rob_box_description)/urdf/materials/rob_box_materials.xacro" />
  
  <!-- ros2_control конфигурация -->
  <xacro:include filename="$(find rob_box_description)/urdf/rob_box_ros2_control.xacro" />
  
  <!-- Сенсоры -->
  <xacro:include filename="$(find rob_box_description)/urdf/sensors/rob_box_sensors.xacro" />
  
  <!-- ═══════════════════════════════════════════════════════════════ -->
  <!-- BASE LINK - Основной корпус робота -->
  <!-- ═══════════════════════════════════════════════════════════════ -->
  
  <link name="base_link">
    <inertial>
      <origin xyz="-2.409e-05 0.025488 0.145292" rpy="0 0 0"/>
      <mass value="62.645"/>
      <inertia ixx="2.829827" iyy="1.926172" izz="3.653023" 
               ixy="-0.001791" iyz="-0.302171" ixz="-0.001655"/>
    </inertial>
    
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://rob_box_description/meshes/base_link.stl" 
              scale="0.001 0.001 0.001"/>
      </geometry>
      <material name="rob_box_white"/>
    </visual>
    
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://rob_box_description/meshes/base_link.stl" 
              scale="0.001 0.001 0.001"/>
      </geometry>
    </collision>
  </link>
  
  <!-- ═══════════════════════════════════════════════════════════════ -->
  <!-- КОЛЕСА - Rear Left -->
  <!-- ═══════════════════════════════════════════════════════════════ -->
  
  <link name="rear_left_wheel_link">
    <inertial>
      <origin xyz="0.0375 0.0 0.0" rpy="0 0 0"/>
      <mass value="21.682"/>
      <inertia ixx="0.129466" iyy="0.073667" izz="0.073667" 
               ixy="0.0" iyz="0.0" ixz="0.0"/>
    </inertial>
    
    <visual>
      <!-- Mesh имеет координаты относительно base_link, смещаем в wheel_link origin -->
      <origin xyz="${-wheel_rear_left_x} ${-wheel_rear_left_y} ${-wheel_rear_left_z}" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://rob_box_description/meshes/wheel_rear_left_1.stl" 
              scale="0.001 0.001 0.001"/>
      </geometry>
      <material name="wheel_black"/>
    </visual>
    
    <collision>
      <origin xyz="0 0 0" rpy="0 ${M_PI/2} 0"/>
      <geometry>
        <cylinder radius="${wheel_radius}" length="${wheel_width}"/>
      </geometry>
    </collision>
  </link>
  
  <joint name="rear_left_wheel_joint" type="continuous">
    <origin xyz="${wheel_rear_left_x} ${wheel_rear_left_y} ${wheel_rear_left_z}" rpy="0 0 0"/>
    <parent link="base_link"/>
    <child link="rear_left_wheel_link"/>
    <axis xyz="1 0 0"/>
    <dynamics damping="0.1" friction="0.1"/>
  </joint>
  
  <!-- ═══════════════════════════════════════════════════════════════ -->
  <!-- КОЛЕСА - Front Left -->
  <!-- ═══════════════════════════════════════════════════════════════ -->
  
  <link name="front_left_wheel_link">
    <inertial>
      <origin xyz="0.0375 0.0 0.0" rpy="0 0 0"/>
      <mass value="21.682"/>
      <inertia ixx="0.129466" iyy="0.073667" izz="0.073667" 
               ixy="0.0" iyz="0.0" ixz="0.0"/>
    </inertial>
    
    <visual>
      <!-- Mesh имеет координаты относительно base_link, смещаем в wheel_link origin -->
      <origin xyz="${-wheel_front_left_x} ${-wheel_front_left_y} ${-wheel_front_left_z}" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://rob_box_description/meshes/wheel_front_left_1.stl" 
              scale="0.001 0.001 0.001"/>
      </geometry>
      <material name="wheel_black"/>
    </visual>
    
    <collision>
      <origin xyz="0 0 0" rpy="0 ${M_PI/2} 0"/>
      <geometry>
        <cylinder radius="${wheel_radius}" length="${wheel_width}"/>
      </geometry>
    </collision>
  </link>
  
  <joint name="front_left_wheel_joint" type="continuous">
    <origin xyz="${wheel_front_left_x} ${wheel_front_left_y} ${wheel_front_left_z}" rpy="0 0 0"/>
    <parent link="base_link"/>
    <child link="front_left_wheel_link"/>
    <axis xyz="1 0 0"/>
    <dynamics damping="0.1" friction="0.1"/>
  </joint>
  
  <!-- ═══════════════════════════════════════════════════════════════ -->
  <!-- КОЛЕСА - Front Right -->
  <!-- ═══════════════════════════════════════════════════════════════ -->
  
  <link name="front_right_wheel_link">
    <inertial>
      <origin xyz="-0.0375 0.0 0.0" rpy="0 0 0"/>
      <mass value="21.682"/>
      <inertia ixx="0.129466" iyy="0.073667" izz="0.073667" 
               ixy="0.0" iyz="0.0" ixz="0.0"/>
    </inertial>
    
    <visual>
      <!-- Mesh имеет координаты относительно base_link, смещаем в wheel_link origin -->
      <origin xyz="${-wheel_front_right_x} ${-wheel_front_right_y} ${-wheel_front_right_z}" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://rob_box_description/meshes/wheel_front_right_1.stl" 
              scale="0.001 0.001 0.001"/>
      </geometry>
      <material name="wheel_black"/>
    </visual>
    
    <collision>
      <origin xyz="0 0 0" rpy="0 ${M_PI/2} 0"/>
      <geometry>
        <cylinder radius="${wheel_radius}" length="${wheel_width}"/>
      </geometry>
    </collision>
  </link>
  
  <joint name="front_right_wheel_joint" type="continuous">
    <origin xyz="${wheel_front_right_x} ${wheel_front_right_y} ${wheel_front_right_z}" rpy="0 0 0"/>
    <parent link="base_link"/>
    <child link="front_right_wheel_link"/>
    <axis xyz="-1 0 0"/>
    <dynamics damping="0.1" friction="0.1"/>
  </joint>
  
  <!-- ═══════════════════════════════════════════════════════════════ -->
  <!-- КОЛЕСА - Rear Right -->
  <!-- ═══════════════════════════════════════════════════════════════ -->
  
  <link name="rear_right_wheel_link">
    <inertial>
      <origin xyz="-0.0375 0.0 0.0" rpy="0 0 0"/>
      <mass value="21.682"/>
      <inertia ixx="0.129466" iyy="0.073667" izz="0.073667" 
               ixy="0.0" iyz="0.0" ixz="0.0"/>
    </inertial>
    
    <visual>
      <!-- Mesh имеет координаты относительно base_link, смещаем в wheel_link origin -->
      <origin xyz="${-wheel_rear_right_x} ${-wheel_rear_right_y} ${-wheel_rear_right_z}" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://rob_box_description/meshes/wheel_rear_right_1.stl" 
              scale="0.001 0.001 0.001"/>
      </geometry>
      <material name="wheel_black"/>
    </visual>
    
    <collision>
      <origin xyz="0 0 0" rpy="0 ${M_PI/2} 0"/>
      <geometry>
        <cylinder radius="${wheel_radius}" length="${wheel_width}"/>
      </geometry>
    </collision>
  </link>
  
  <joint name="rear_right_wheel_joint" type="continuous">
    <origin xyz="${wheel_rear_right_x} ${wheel_rear_right_y} ${wheel_rear_right_z}" rpy="0 0 0"/>
    <parent link="base_link"/>
    <child link="rear_right_wheel_link"/>
    <axis xyz="-1 0 0"/>
    <dynamics damping="0.1" friction="0.1"/>
  </joint>
  
  <!-- ═══════════════════════════════════════════════════════════════ -->
  <!-- СЕНСОРЫ -->
  <!-- ═══════════════════════════════════════════════════════════════ -->
  
  <!-- LSLIDAR N10 -->
  <xacro:lslidar_n10 
    parent_link="base_link"
    xyz="${lidar_x} ${lidar_y} ${lidar_z}"
    rpy="0 0 0"/>
  
  <!-- OAK-D Lite (смотрит вперед по Y+) -->
  <xacro:oak_d_lite 
    parent_link="base_link"
    xyz="${oak_d_x} ${oak_d_y} ${oak_d_z}"
    rpy="0 0 0"/>
  
  <!-- RPi Camera (смотрит ВВЕРХ по Z+) -->
  <!-- Pitch = -90° чтобы повернуть камеру с Y+ на Z+ -->
  <xacro:rpi_camera_ceiling 
    parent_link="base_link"
    xyz="${rpi_cam_x} ${rpi_cam_y} ${rpi_cam_z}"
    rpy="0 ${-M_PI/2} 0"/>
  
</robot>
