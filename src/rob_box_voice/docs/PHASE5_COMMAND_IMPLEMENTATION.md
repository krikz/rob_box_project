# Phase 5: Command Recognition Node

## –û–±–∑–æ—Ä

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ  
**–î–∞—Ç–∞**: 2025-10-13  
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**: –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–±–æ—Ç–æ–º

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### Command Node

**–§–∞–π–ª**: `rob_box_voice/command_node.py` (415 —Å—Ç—Ä–æ–∫)

**ROS –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å**:
```
Subscribers:
  /voice/stt/result (String)          - –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–∞—è —Ä–µ—á—å –æ—Ç STT

Publishers:
  /voice/command/intent (String)      - –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ
  /voice/command/feedback (String)    - Feedback –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

Action Clients:
  /navigate_to_pose (NavigateToPose)  - Nav2 –Ω–∞–≤–∏–≥–∞—Ü–∏—è
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
```yaml
confidence_threshold: 0.7       # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
enable_navigation: true         # Nav2 –∫–æ–º–∞–Ω–¥—ã
enable_follow: false            # –°–ª–µ–¥–æ–≤–∞–Ω–∏–µ (TODO)
enable_vision: false            # –ó—Ä–µ–Ω–∏–µ (TODO)
```

## Intent Classification

### –¢–∏–ø—ã –Ω–∞–º–µ—Ä–µ–Ω–∏–π

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ**:
- `NAVIGATE` - –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫ —Ç–æ—á–∫–µ
- `STOP` - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è
- `STATUS` - –ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞/–ø–æ–∑–∏—Ü–∏–∏
- `MAP` - –†–∞–±–æ—Ç–∞ —Å –∫–∞—Ä—Ç–æ–π
- `VISION` - –ó—Ä–µ–Ω–∏–µ/–¥–µ—Ç–µ–∫—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤
- `FOLLOW` - –†–µ–∂–∏–º —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

### –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è

**–ù–∞–≤–∏–≥–∞—Ü–∏—è** (`NAVIGATE`):
```python
"–¥–≤–∏–≥–∞–π—Å—è –∫ —Ç–æ—á–∫–µ 3"      ‚Üí waypoint_number: 3
"–∏–¥–∏ –∫ –∫—É—Ö–Ω—è"             ‚Üí waypoint_name: –∫—É—Ö–Ω—è
"–ø–æ–µ–∑–∂–∞–π –∫ –¥–æ–º"           ‚Üí waypoint_name: –¥–æ–º
"–¥–≤–∏–≥–∞–π—Å—è –≤–ø–µ—Ä–µ–¥"         ‚Üí direction: –≤–ø–µ—Ä–µ–¥
```

**–û—Å—Ç–∞–Ω–æ–≤–∫–∞** (`STOP`):
```python
"—Å—Ç–æ–ø"                    ‚Üí immediate stop
"–æ—Å—Ç–∞–Ω–æ–≤–∏—Å—å"              ‚Üí immediate stop
"–æ—Ç–º–µ–Ω–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—é"        ‚Üí cancel navigation
```

**–°—Ç–∞—Ç—É—Å** (`STATUS`):
```python
"–≥–¥–µ —Ç—ã"                  ‚Üí position query
"–ø–æ–∫–∞–∂–∏ —Å—Ç–∞—Ç—É—Å"           ‚Üí status report
"—Ä–∞—Å—Å–∫–∞–∂–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã"     ‚Üí coordinates query
```

**–ö–∞—Ä—Ç–∞** (`MAP`):
```python
"–ø–æ–∫–∞–∂–∏ –∫–∞—Ä—Ç—É"            ‚Üí display map
"–ø–æ—Å—Ç—Ä–æ–π –∫–∞—Ä—Ç—É"           ‚Üí start SLAM
```

**–ó—Ä–µ–Ω–∏–µ** (`VISION`):
```python
"—á—Ç–æ –≤–∏–¥–∏—à—å"              ‚Üí object detection
"–Ω–∞–π–¥–∏ —á–µ–ª–æ–≤–µ–∫–∞"          ‚Üí person detection
```

**–°–ª–µ–¥–æ–≤–∞–Ω–∏–µ** (`FOLLOW`):
```python
"—Å–ª–µ–¥—É–π –∑–∞ –º–Ω–æ–π"          ‚Üí follow mode
"–≤–∫–ª—é—á–∏ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ"       ‚Üí activate following
```

### –ê–ª–≥–æ—Ä–∏—Ç–º –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏

1. **Pattern Matching**:
   - Regex –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º
   - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ entities (—á–∏—Å–ª–∞, –Ω–∞–∑–≤–∞–Ω–∏—è)

2. **Confidence Scoring**:
   ```python
   confidence = 0.8 + (match_length / text_length) * 0.2
   ```

3. **Entity Extraction**:
   - `waypoint_number`: "—Ç–æ—á–∫–µ 3" ‚Üí 3
   - `waypoint_name`: "–∫ –∫—É—Ö–Ω—è" ‚Üí "–∫—É—Ö–Ω—è"
   - `direction`: "–≤–ø–µ—Ä–µ–¥" ‚Üí "–≤–ø–µ—Ä–µ–¥"

4. **Best Match Selection**:
   - –í—ã–±–æ—Ä –ø–∞—Ç—Ç–µ—Ä–Ω–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é

## Waypoints System

### –ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Ç–æ—á–∫–∏

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** (`voice_assistant.yaml`):
```yaml
waypoints:
  –¥–æ–º:       {x: 0.0, y: 0.0, theta: 0.0}
  –∫—É—Ö–Ω—è:     {x: 2.0, y: 1.0, theta: 0.0}
  –≥–æ—Å—Ç–∏–Ω–∞—è:  {x: 3.0, y: 2.0, theta: 1.57}
  —Ç–æ—á–∫–∞_1:   {x: 1.0, y: 0.0, theta: 0.0}
  —Ç–æ—á–∫–∞_2:   {x: 2.0, y: 0.0, theta: 0.0}
  —Ç–æ—á–∫–∞_3:   {x: 3.0, y: 0.0, theta: 0.0}
```

**–§–æ—Ä–º–∞—Ç**:
- `x`, `y` - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –º–µ—Ç—Ä–∞—Ö (frame: map)
- `theta` - –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –≤ —Ä–∞–¥–∏–∞–Ω–∞—Ö (0 = –≤–ø–µ—Ä—ë–¥, œÄ/2 = –≤–ª–µ–≤–æ)

### –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ

**TODO**: –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏:
```python
"–∑–∞–ø–æ–º–Ω–∏ —ç—Ç—É —Ç–æ—á–∫—É –∫–∞–∫ —Å–ø–∞–ª—å–Ω—è"  ‚Üí save current pose
"—Å–æ—Ö—Ä–∞–Ω–∏ waypoint –æ—Ñ–∏—Å"          ‚Üí save current pose
```

## Nav2 Integration

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–º–∞–Ω–¥ —Å–∫–æ—Ä–æ—Å—Ç–∏

**‚ö†Ô∏è –í–ê–ñ–ù–û**: Command Node –ù–ï –ø—É–±–ª–∏–∫—É–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –≤ `/cmd_vel`!

**–ü–æ—Ç–æ–∫ –∫–æ–º–∞–Ω–¥**:
```
Voice ‚Üí STT ‚Üí Command Node ‚Üí Nav2 Action Client
                                   ‚Üì
                            NavigateToPose
                                   ‚Üì
                            Nav2 Controller
                                   ‚Üì
                              /cmd_vel (topic)
                                   ‚Üì
                            üéÆ twist_mux (–ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è)
                                   ‚Üì
                         /diff_cont/cmd_vel_unstamped
                                   ‚Üì
                            ros2_control ‚Üí –ú–æ—Ç–æ—Ä—ã
```

### Twist Mux - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∫–æ–º–∞–Ω–¥

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** (`docker/main/config/twist_mux/twist_mux.yaml`):

| –ò—Å—Ç–æ—á–Ω–∏–∫ | Topic | Priority | Timeout | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-------|----------|---------|----------|
| üö® Emergency | `/cmd_vel_emergency` | **255** | 0.1s | –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ |
| üéÆ Joystick | `/cmd_vel_joy` | **100** | 0.5s | –†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–¥–∂–æ–π—Å—Ç–∏–∫) |
| üñ•Ô∏è Web UI | `/cmd_vel_web` | **50** | 1.0s | –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å |
| ü§ñ Nav2 | `/cmd_vel` | **10** | 0.5s | –ê–≤—Ç–æ–Ω–æ–º–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è |

**–õ–æ–≥–∏–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤**:
- **Joystick –∞–∫—Ç–∏–≤–µ–Ω** ‚Üí Nav2 –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è (—á–µ–ª–æ–≤–µ–∫ > –∞–≤—Ç–æ–Ω–æ–º–∏—è)
- **Joystick –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω** ‚Üí Nav2 –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å
- **Emergency stop** ‚Üí –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å—ë

**–ü—Ä–∏–º–µ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è**:
```
1. Robot –≥–æ–≤–æ—Ä–∏—Ç: "–ò–¥—É –∫ –∫—É—Ö–Ω—è"
2. Nav2 –ø—É–±–ª–∏–∫—É–µ—Ç –≤ /cmd_vel (priority 10)
3. Twist Mux –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã ‚Üí –º–æ—Ç–æ—Ä—ã
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ—Ä—ë—Ç –¥–∂–æ–π—Å—Ç–∏–∫
5. –î–∂–æ–π—Å—Ç–∏–∫ –ø—É–±–ª–∏–∫—É–µ—Ç –≤ /cmd_vel_joy (priority 100)
6. Twist Mux –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è ‚Üí Nav2 –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
7. –†–æ–±–æ—Ç –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, —Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
8. –î–∂–æ–π—Å—Ç–∏–∫ –æ—Ç–ø—É—â–µ–Ω (timeout 0.5s)
9. Twist Mux –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Nav2
10. –†–æ–±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏—é –∫ –∫—É—Ö–Ω–µ
```

### NavigateToPose Action

**–ü—Ä–æ—Ü–µ—Å—Å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏**:

1. **Goal Creation**:
   ```python
   goal = NavigateToPose.Goal()
   goal.pose.header.frame_id = 'map'
   goal.pose.pose.position.x = 2.0
   goal.pose.pose.position.y = 1.0
   goal.pose.pose.orientation.w = 1.0  # theta=0
   ```

2. **Goal Submission**:
   ```python
   future = self.nav_client.send_goal_async(goal, feedback_callback)
   ```

3. **Feedback Monitoring**:
   - Progress updates (distance remaining, ETA)
   - Obstacles detected
   - Recovery behaviors triggered

4. **Result Handling**:
   - Success: "–ü—Ä–∏–±—ã–ª –≤ —Ç–æ—á–∫—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è"
   - Failure: "–ù–µ –º–æ–≥—É –≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é"
   - Cancel: "–û—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è"

**–í–∞–∂–Ω–æ**: Command Node —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ü–µ–ª–∏ Nav2. –†–µ–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ—Ç–æ—Ä–∞–º–∏ –¥–µ–ª–∞–µ—Ç Nav2 —á–µ—Ä–µ–∑ twist_mux

### Coordinate Systems

**map frame**:
- Origin: (0, 0) = starting position
- X-axis: forward
- Y-axis: left
- Z-axis: up

**Orientation**:
```python
theta = 0.0    ‚Üí 0¬∞   (forward)
theta = œÄ/2    ‚Üí 90¬∞  (left)
theta = œÄ      ‚Üí 180¬∞ (backward)
theta = -œÄ/2   ‚Üí 270¬∞ (right)
```

**Quaternion conversion**:
```python
orientation.z = sin(theta / 2.0)
orientation.w = cos(theta / 2.0)
```

## Dialogue Integration

### Feedback Loop

```
User Speech ‚Üí STT ‚Üí Command Node ‚Üí Nav2
                ‚Üì                     ‚Üì
         Dialogue Node ‚Üê Feedback ‚Üê‚îÄ‚îò
                ‚Üì
              TTS ‚Üí Speech + Audio-Reactive Animations
                         ‚Üì
                   üé§ Audio Output
                         ‚Üì
              audio_reactive_animation_node
                         ‚Üì
                   /audio/level (Float32)
                         ‚Üì
              animation_player_node
                         ‚Üì
                   üëÑ Mouth Animation (lip-sync)
```

**–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞**:

1. **User**: "–î–≤–∏–≥–∞–π—Å—è –∫ —Ç–æ—á–∫–µ —Ç—Ä–∏"
2. **STT**: "–¥–≤–∏–≥–∞–π—Å—è –∫ —Ç–æ—á–∫–µ —Ç—Ä–∏"
3. **Command**: Intent=NAVIGATE, waypoint="—Ç–æ—á–∫–∞ 3"
4. **Feedback**: "–ò–¥—É –∫ —Ç–æ—á–∫–∞ 3" ‚Üí TTS
5. **TTS**: –°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ ‚Üí `/voice/audio/speech`
6. **Audio Reactive Node**: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–≤—É–∫–æ–≤–æ–π –∫–∞—Ä—Ç—ã ‚Üí `/audio/level`
7. **Animation Player**: Mouth frames (0-11) –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≥—Ä–æ–º–∫–æ—Å—Ç–∏
8. **Nav2**: NavigateToPose(x=3.0, y=0.0)
9. *[—Ä–æ–±–æ—Ç –µ–¥–µ—Ç, —Ä–æ—Ç –¥–≤–∏–≥–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ—á–∏]*
10. **Nav2 Result**: SUCCESS
11. **Feedback**: "–ü—Ä–∏–±—ã–ª –≤ —Ç–æ—á–∫—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è" ‚Üí TTS + Mouth Animation

### Audio-Reactive Animations

**–°–∏—Å—Ç–µ–º–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ä—Ç–∞ —Ä–æ–±–æ—Ç–∞ —Å —Ä–µ—á—å—é**:

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
- `audio_reactive_animation_node.py` - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞—É–¥–∏–æ –≤—ã—Ö–æ–¥–∞ (PyAudio)
- `animation_player_node` - –í—ã–±–æ—Ä –∫–∞–¥—Ä–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ —É—Ä–æ–≤–Ω—é –≥—Ä–æ–º–∫–æ—Å—Ç–∏
- `talking.yaml` - –ú–∞–Ω–∏—Ñ–µ—Å—Ç —Å 12 –∫–∞–¥—Ä–∞–º–∏ mouth animation

**–ê–ª–≥–æ—Ä–∏—Ç–º**:
1. PyAudio –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∞—É–¥–∏–æ –≤—ã—Ö–æ–¥ —Å–∏—Å—Ç–µ–º—ã (loopback/stereo mix)
2. –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è RMS –≥—Ä–æ–º–∫–æ—Å—Ç—å
3. –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ (smoothing)
4. –ü—É–±–ª–∏–∫—É–µ—Ç—Å—è –≤ `/audio/level` (0.0-1.0)
5. Animation player –≤—ã–±–∏—Ä–∞–µ—Ç –∫–∞–¥—Ä: `frame = int(audio_level * 11)`
6. LED –º–∞—Ç—Ä–∏—Ü–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–æ—Ç (–æ—Ç–∫—Ä—ã—Ç—ã–π/–∑–∞–∫—Ä—ã—Ç—ã–π)

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** (`animations/manifests/talking.yaml`):
```yaml
mouth_panel:
  audio_controlled: true  # –†–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ –∑–≤—É–∫
  frames:
    - frame_0.png  # –†–æ—Ç –∑–∞–∫—Ä—ã—Ç (audio_level = 0.0)
    - frame_1.png  # –ß—É—Ç—å –ø—Ä–∏–æ—Ç–∫—Ä—ã—Ç
    ...
    - frame_11.png # –®–∏—Ä–æ–∫–æ –æ—Ç–∫—Ä—ã—Ç (audio_level = 1.0)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –†–æ—Ç —Ä–æ–±–æ—Ç–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è/–∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å —Ä–µ—á—å—é (—ç—Ñ—Ñ–µ–∫—Ç –∫–∞–∫ —É Bender –∏–∑ Futurama)

### Emotion-Based Animations

**–°–∏—Å—Ç–µ–º–∞ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∞–Ω–∏–º–∞—Ü–∏–π** (–±—É–¥—É—â–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è):

**DeepSeek Response JSON** (—Ç–µ–∫—É—â–∏–π —Ñ–æ—Ä–º–∞—Ç):
```json
{
  "chunk": 1,
  "ssml": "<speak>–¢–µ–∫—Å—Ç</speak>",
  "emotion": "happy"  ‚Üê –ü–æ–ª–µ —ç–º–æ—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
}
```

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —ç–º–æ—Ü–∏–∏**:
- `neutral` - –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (eyes_neutral.yaml)
- `happy` - –†–∞–¥–æ—Å—Ç—å (happy.yaml + sound: cute/very_cute)
- `sad` - –ì—Ä—É—Å—Ç—å (sad.yaml)
- `thinking` - –†–∞–∑–º—ã—à–ª–µ–Ω–∏–µ (thinking.yaml + sound: thinking)
- `alert` - –¢—Ä–µ–≤–æ–≥–∞ (alert.yaml)
- `angry` - –ó–ª–æ—Å—Ç—å (angry.yaml + sound: angry_1/angry_2)
- `surprised` - –£–¥–∏–≤–ª–µ–Ω–∏–µ (surprised.yaml + sound: surprise)

**TODO - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å dialogue_node**:
```python
def dialogue_callback(self, msg: String):
    chunk_data = json.loads(msg.data)
    
    # –¢–µ–∫—É—â–µ–µ: —Ç–æ–ª—å–∫–æ TTS
    ssml = chunk_data['ssml']
    self.tts_pub.publish(ssml)
    
    # TODO: –¢—Ä–∏–≥–≥–µ—Ä –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ —ç–º–æ—Ü–∏–∏
    if 'emotion' in chunk_data:
        emotion = chunk_data['emotion']
        self._trigger_animation(emotion)  # ‚Üí /animations/trigger
        self._trigger_sound(emotion)      # ‚Üí /voice/sound/trigger
```

**–ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–π –ø–æ—Ç–æ–∫**:
```
DeepSeek ‚Üí {"emotion": "happy"}
    ‚Üì
dialogue_node
    ‚Üì
    ‚îú‚Üí TTS (speech)
    ‚îú‚Üí /animations/trigger ("happy")
    ‚îî‚Üí /voice/sound/trigger ("cute")
         ‚Üì
    Animation Player + Sound Node
         ‚Üì
    üòä –†–æ–±–æ—Ç —É–ª—ã–±–∞–µ—Ç—Å—è + –∑–≤—É–∫ —Ä–∞–¥–æ—Å—Ç–∏
```

### Command Confirmation

**TODO**: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–∞—Å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥:
```
User: "–î–≤–∏–≥–∞–π—Å—è –∫ –æ–±—Ä—ã–≤"
Robot: "–í—ã —É–≤–µ—Ä–µ–Ω—ã? –¢–∞–º –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø–∞—Å–Ω–æ"
User: "–î–∞, —É–≤–µ—Ä–µ–Ω"
Robot: "–•–æ—Ä–æ—à–æ, –≤—ã–ø–æ–ª–Ω—è—é"
```

## Testing

### Test Script

**–§–∞–π–ª**: `scripts/test_command_node.py`

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**:
- 24 —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥—ã (–≤—Å–µ —Ç–∏–ø—ã)
- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é
- –ü—Ä—è–º–æ–π –≤–≤–æ–¥ —Å–≤–æ–∏—Ö –∫–æ–º–∞–Ω–¥
- Batch testing (–≤—Å–µ –ø–æ–¥—Ä—è–¥)

**–ó–∞–ø—É—Å–∫**:
```bash
# –¢–µ—Ä–º–∏–Ω–∞–ª 1: –ó–∞–ø—É—Å—Ç–∏—Ç—å command_node
ros2 run rob_box_voice command_node

# –¢–µ—Ä–º–∏–Ω–∞–ª 2: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–µ—Ä
cd src/rob_box_voice/scripts
python3 test_command_node.py
```

### Manual Testing

**–≠–º—É–ª—è—Ü–∏—è STT**:
```bash
ros2 topic pub --once /voice/stt/result std_msgs/String "data: '–¥–≤–∏–≥–∞–π—Å—è –∫ —Ç–æ—á–∫–µ —Ç—Ä–∏'"
```

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:
```bash
# Intent
ros2 topic echo /voice/command/intent

# Feedback
ros2 topic echo /voice/command/feedback

# Nav2 goal
ros2 topic echo /goal_pose
```

### Integration Test

**–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª**:
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å Voice Assistant
ros2 launch rob_box_voice voice_assistant.launch.py

# –ó–∞–ø—É—Å—Ç–∏—Ç—å Nav2 (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–ø—É—â–µ–Ω)
docker-compose up -d nav2

# –ì–æ–≤–æ—Ä–∏—Ç—å –≤ –º–∏–∫—Ä–æ—Ñ–æ–Ω:
"–î–≤–∏–≥–∞–π—Å—è –∫ —Ç–æ—á–∫–µ —Ç—Ä–∏"

# –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
# 1. STT ‚Üí "–¥–≤–∏–≥–∞–π—Å—è –∫ —Ç–æ—á–∫–µ —Ç—Ä–∏"
# 2. Command ‚Üí Intent=NAVIGATE
# 3. TTS ‚Üí "–ò–¥—É –∫ —Ç–æ—á–∫–∞ —Ç—Ä–∏"
# 4. Nav2 ‚Üí robot moves
# 5. TTS ‚Üí "–ü—Ä–∏–±—ã–ª –≤ —Ç–æ—á–∫—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è"
```

## Performance

### –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –í—Ä–µ–º—è | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è |
|-----------|-------|-------------|
| Pattern Match | <10ms | ‚úÖ Regex |
| Entity Extract | <5ms | ‚úÖ Regex groups |
| Nav2 Goal Send | <50ms | ‚úÖ Async |
| **Total** | **~65ms** | üöÄ Real-time |

### CPU/Memory

```
Command Node: ~5% CPU (idle)
Nav2 Client:  ~10% CPU (navigation)
RAM:          ~20 MB
```

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–æ–º–∞–Ω–¥—ã –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω—ã**:
1. –ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (`confidence < threshold`)
2. –ü–∞—Ç—Ç–µ—Ä–Ω –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–º–∞–Ω–¥–æ–π
3. STT –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª —Ä–µ—á—å

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ command_node
ros2 run rob_box_voice command_node

# –û–∂–∏–¥–∞–µ—Ç—Å—è:
# üé§ STT: –¥–≤–∏–≥–∞–π—Å—è –∫ —Ç–æ—á–∫–µ —Ç—Ä–∏
# üéØ Intent: navigate (0.85)
# üì¶ Entities: {'waypoint': '—Ç–æ—á–∫–∞ 3'}
```

**–†–µ—à–µ–Ω–∏–µ**:
- –°–Ω–∏–∑–∏—Ç—å `confidence_threshold` (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0.5)
- –î–æ–±–∞–≤–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- –£–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ STT (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª—å—à—É—é Vosk –º–æ–¥–µ–ª—å)

### –ü—Ä–æ–±–ª–µ–º–∞: Nav2 goal –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω—ã**:
1. Nav2 action server –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
2. Waypoint –Ω–µ –Ω–∞–π–¥–µ–Ω
3. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Nav2
ros2 node list | grep navigator

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å action server
ros2 action list | grep navigate_to_pose

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å waypoints
ros2 param get /command_node waypoints
```

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å Nav2
docker-compose up -d nav2

# –î–æ–±–∞–≤–∏—Ç—å waypoint –≤ config
# voice_assistant.yaml:
# waypoints:
#   –Ω–æ–≤–∞—è_—Ç–æ—á–∫–∞: {x: 4.0, y: 2.0, theta: 0.0}
```

### –ü—Ä–æ–±–ª–µ–º–∞: –†–æ–±–æ—Ç –Ω–µ –¥–≤–∏–∂–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω—ã**:
1. Nav2 –Ω–µ –∑–∞–ø—É—â–µ–Ω
2. –ö–∞—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (`/map` topic missing)
3. –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (`/odom` missing)
4. **Twist Mux –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã** (–¥–∂–æ–π—Å—Ç–∏–∫ –∞–∫—Ç–∏–≤–µ–Ω)
5. ros2_control –Ω–µ –∑–∞–ø—É—â–µ–Ω

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**:
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–ø–∏–∫–∏
ros2 topic list | grep -E "/map|/odom|/cmd_vel"

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Nav2 –Ω–æ–¥—ã
ros2 node list | grep -E "controller|planner|navigator"

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Twist Mux (–í–ê–ñ–ù–û!)
ros2 topic echo /cmd_vel                    # Nav2 output
ros2 topic echo /diff_cont/cmd_vel_unstamped # Twist Mux output
ros2 topic echo /cmd_vel_joy                # Joystick (–º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å!)

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
ros2 param get /twist_mux topics

# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–ø–∏–∫–∏ Twist Mux
ros2 topic hz /cmd_vel_joy    # –ï—Å–ª–∏ >0 Hz ‚Üí –¥–∂–æ–π—Å—Ç–∏–∫ –±–ª–æ–∫–∏—Ä—É–µ—Ç Nav2!
```

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π —Å—Ç–µ–∫
docker-compose up -d rtabmap nav2 ros2-control twist-mux

# 2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∂–æ–π—Å—Ç–∏–∫ –ù–ï –ø—É–±–ª–∏–∫—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã
ros2 topic hz /cmd_vel_joy  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 0 Hz –∏–ª–∏ "no messages"

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Nav2 –ø—É–±–ª–∏–∫—É–µ—Ç
ros2 topic hz /cmd_vel  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å ~10-20 Hz –≤–æ –≤—Ä–µ–º—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Twist Mux –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã
ros2 topic hz /diff_cont/cmd_vel_unstamped  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å ~10-20 Hz

# 5. –ï—Å–ª–∏ –¥–∂–æ–π—Å—Ç–∏–∫ –±–ª–æ–∫–∏—Ä—É–µ—Ç - –ø–æ–¥–æ–∂–¥–∞—Ç—å timeout (0.5s)
# –ò–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å twist-mux:
docker restart twist-mux
```

### –ü—Ä–æ–±–ª–µ–º–∞: Mouth animation –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞

**–ü—Ä–∏—á–∏–Ω—ã**:
1. `audio_reactive_animation_node` –Ω–µ –∑–∞–ø—É—â–µ–Ω
2. PyAudio –Ω–µ –º–æ–∂–µ—Ç –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –∞—É–¥–∏–æ –≤—ã—Ö–æ–¥
3. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞—É–¥–∏–æ –¥–µ–≤–∞–π—Å
4. `audio_controlled: false` –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**:
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–¥—É
ros2 node list | grep audio_reactive

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–ø–∏–∫ —É—Ä–æ–≤–Ω—è –∑–≤—É–∫–∞
ros2 topic hz /audio/level  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å ~20-50 Hz

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PyAudio devices
python3 -c "import pyaudio; pa = pyaudio.PyAudio(); \
    print([pa.get_device_info_by_index(i) for i in range(pa.get_device_count())])"

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∞–Ω–∏—Ñ–µ—Å—Ç
grep "audio_controlled" src/rob_box_animations/animations/manifests/talking.yaml
```

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å audio reactive node
ros2 run rob_box_animations audio_reactive_animation_node

# 2. –í–∫–ª—é—á–∏—Ç—å loopback –Ω–∞ –∑–≤—É–∫–æ–≤–æ–π –∫–∞—Ä—Ç–µ (Linux)
pactl load-module module-loopback

# 3. –£–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π device –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
ros2 param set /audio_reactive_animation_node audio_device_index 2

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –º–∞–Ω–∏—Ñ–µ—Å—Ç talking.yaml –∏–º–µ–µ—Ç:
# mouth_panel:
#   audio_controlled: true
```

## Future Enhancements

### Phase 6: Advanced Commands

**Person Following**:
```python
"—Å–ª–µ–¥—É–π –∑–∞ –º–Ω–æ–π"           ‚Üí activate person tracking
"—Å–ª–µ–¥—É–π –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ 1–º"  ‚Üí set follow distance
"–ø–µ—Ä–µ—Å—Ç–∞–Ω—å —Å–ª–µ–¥–æ–≤–∞—Ç—å"      ‚Üí deactivate following
```

**Object Manipulation**:
```python
"–≤–æ–∑—å–º–∏ –∫—Ä–∞—Å–Ω—ã–π –∫—É–±–∏–∫"     ‚Üí pick object
"–ø–æ–ª–æ–∂–∏ –Ω–∞ —Å—Ç–æ–ª"           ‚Üí place object
"–ø–æ–¥–∞–π –º–Ω–µ –±—É—Ç—ã–ª–∫—É"        ‚Üí hand over
```

**Multi-step Commands**:
```python
"–∏–¥–∏ –∫ –∫—É—Ö–Ω—è –ø–æ—Ç–æ–º –∫ –≥–æ—Å—Ç–∏–Ω–∞—è"  ‚Üí waypoint sequence
"–Ω–∞–π–¥–∏ —á–µ–ª–æ–≤–µ–∫–∞ –∏ —Å–ª–µ–¥—É–π –∑–∞ –Ω–∏–º" ‚Üí vision + follow
```

### Dynamic Waypoint Learning

**Concept**: –†–æ–±–æ—Ç –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –ø–æ—Å–µ—â—ë–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:
```
User: "–ó–∞–ø–æ–º–Ω–∏ —ç—Ç—É —Ç–æ—á–∫—É –∫–∞–∫ –æ—Ñ–∏—Å"
Robot: "–•–æ—Ä–æ—à–æ, —Å–æ—Ö—Ä–∞–Ω–∏–ª —Ç–æ—á–∫—É –æ—Ñ–∏—Å"

User: "–î–≤–∏–≥–∞–π—Å—è –∫ –æ—Ñ–∏—Å"
Robot: "–ò–¥—É –∫ –æ—Ñ–∏—Å" ‚Üí NavigateToPose(saved_coords)
```

**Implementation**:
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ ROS2 parameters
- Persistence –≤ YAML —Ñ–∞–π–ª
- –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö waypoints

### Natural Language Understanding (NLU)

**–¢–µ–∫—É—â–µ–µ**: Rule-based regex patterns  
**–ë—É–¥—É—â–µ–µ**: ML-based intent classifier

**Options**:
1. **RASA NLU**: Open-source NLU
2. **spaCy + custom model**: Russian NER
3. **DeepSeek classification**: Use LLM for intent

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –ë–æ–ª–µ–µ –≥–∏–±–∫–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–µ—á–∞—Ç–æ–∫/–≤–∞—Ä–∏–∞—Ü–∏–π
- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ

## References

- [Nav2 Actions](https://navigation.ros.org/tutorials/docs/using_plugins.html)
- [ROS2 Action Clients](https://docs.ros.org/en/humble/Tutorials/Intermediate/Writing-an-Action-Server-Client/Py.html)
- [Regex in Python](https://docs.python.org/3/library/re.html)
- [Twist Mux Documentation](http://wiki.ros.org/twist_mux)
- [Audio-Reactive Animations](../../rob_box_animations/AUDIO_REACTIVE.md)
- [Phase 3: STT](PHASE3_STT_IMPLEMENTATION.md)
- [Phase 4: Sound](PHASE4_SOUND_IMPLEMENTATION.md)

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞

### Voice Command ‚Üí Robot Motion (–ø–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    USER SPEAKS                              ‚îÇ
‚îÇ              "–î–≤–∏–≥–∞–π—Å—è –∫ —Ç–æ—á–∫–µ —Ç—Ä–∏"                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üé§ AUDIO NODE (Phase 1)                                    ‚îÇ
‚îÇ  - Captures microphone ‚Üí /voice/audio/recording             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üó£Ô∏è STT NODE (Phase 3)                                      ‚îÇ
‚îÇ  - Vosk ‚Üí "–¥–≤–∏–≥–∞–π—Å—è –∫ —Ç–æ—á–∫–µ —Ç—Ä–∏" ‚Üí /voice/stt/result       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üéØ COMMAND NODE (Phase 5) ‚Üê YOU ARE HERE                   ‚îÇ
‚îÇ  - Intent: NAVIGATE                                         ‚îÇ
‚îÇ  - Entity: waypoint="—Ç–æ—á–∫–∞ 3"                               ‚îÇ
‚îÇ  - Lookup: {x: 3.0, y: 0.0, theta: 0.0}                     ‚îÇ
‚îÇ  - Send Nav2 Goal (NavigateToPose Action)                   ‚îÇ
‚îÇ  - Feedback ‚Üí /voice/command/feedback: "–ò–¥—É –∫ —Ç–æ—á–∫–∞ 3"      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ                               ‚îÇ
             ‚Üì                               ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üí¨ DIALOGUE NODE      ‚îÇ    ‚îÇ  ü§ñ NAV2 STACK               ‚îÇ
‚îÇ  (Phase 2)             ‚îÇ    ‚îÇ  - Planner: A* path          ‚îÇ
‚îÇ  Receives feedback     ‚îÇ    ‚îÇ  - Controller: DWB           ‚îÇ
‚îÇ  ‚Üí TTS                 ‚îÇ    ‚îÇ  - Costmaps: obstacles       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ  - Publishes: /cmd_vel       ‚îÇ
          ‚îÇ                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚Üì                             ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             ‚Üì
‚îÇ  üîä TTS NODE (Phase 2)  ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  - Silero TTS           ‚îÇ   ‚îÇ  üéÆ TWIST MUX                ‚îÇ
‚îÇ  - "–ò–¥—É –∫ —Ç–æ—á–∫–∞ 3"      ‚îÇ   ‚îÇ  Input priorities:           ‚îÇ
‚îÇ  - Audio output         ‚îÇ   ‚îÇ  1. Emergency (255)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ  2. Joystick (100) ‚Üê blocks  ‚îÇ
          ‚îÇ                   ‚îÇ  3. Web UI (50)              ‚îÇ
          ‚Üì                   ‚îÇ  4. Nav2 (10) ‚Üê /cmd_vel     ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ  Output:                     ‚îÇ
‚îÇ  üé§ AUDIO REACTIVE NODE ‚îÇ   ‚îÇ  ‚Üí /diff_cont/cmd_vel        ‚îÇ
‚îÇ  - Monitors sound card  ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ  - RMS volume           ‚îÇ             ‚îÇ
‚îÇ  - /audio/level (0-1)   ‚îÇ             ‚Üì
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ                   ‚îÇ  ‚öôÔ∏è ROS2_CONTROL             ‚îÇ
          ‚Üì                   ‚îÇ  - diff_drive_controller     ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ  - Odometry /odom            ‚îÇ
‚îÇ  üé® ANIMATION PLAYER    ‚îÇ   ‚îÇ  - Forwards to VESC          ‚îÇ
‚îÇ  - Frame = level * 11   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ  - Mouth open/close     ‚îÇ             ‚îÇ
‚îÇ  - LED matrix update    ‚îÇ             ‚Üì
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                              ‚îÇ  üîß VESC MOTOR CONTROLLERS   ‚îÇ
                              ‚îÇ  - 4x motors (4WD)           ‚îÇ
                              ‚îÇ  - Differential drive        ‚îÇ
                              ‚îÇ  - Robot moves to (3.0, 0.0) ‚îÇ
                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –≠–º–æ—Ü–∏–∏ –≤ –±—É–¥—É—â–µ–º (Phase 6)

**–ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–π –ø–æ—Ç–æ–∫**:

1. **DeepSeek Response** –≤–∫–ª—é—á–∞–µ—Ç `emotion`:
   ```json
   {"chunk": 1, "ssml": "–û—Ç–ª–∏—á–Ω–æ!", "emotion": "happy"}
   ```

2. **Dialogue Node** —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç —ç–º–æ—Ü–∏—é:
   ```python
   if 'emotion' in chunk_data:
       self._trigger_animation(chunk_data['emotion'])  # ‚Üí /animations/trigger
       self._trigger_sound_by_emotion(chunk_data['emotion'])  # ‚Üí /voice/sound/trigger
   ```

3. **Animation Player** –∑–∞–ø—É—Å–∫–∞–µ—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é:
   - `happy.yaml` ‚Üí üòä —É–ª—ã–±–∞–µ—Ç—Å—è
   - `sad.yaml` ‚Üí üò¢ –≥—Ä—É—Å—Ç–∏—Ç
   - `angry.yaml` ‚Üí üò† –∑–ª–∏—Ç—Å—è
   - `thinking.yaml` ‚Üí ü§î —Ä–∞–∑–º—ã—à–ª—è–µ—Ç

4. **Sound Node** –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∑–≤—É–∫:
   - `happy` ‚Üí `cute.mp3` –∏–ª–∏ `very_cute.mp3`
   - `angry` ‚Üí `angry_1.mp3` –∏–ª–∏ `angry_2.mp3`
   - `thinking` ‚Üí `thinking.mp3`
   - `confused` ‚Üí `confused.mp3`

**Mapping —ç–º–æ—Ü–∏–π** (–∏–∑ Phase 4):
```python
emotion_to_sound = {
    'happy': ['cute', 'very_cute'],       # Random choice
    'sad': ['confused'],
    'angry': ['angry_1', 'angry_2'],
    'thinking': ['thinking'],
    'surprised': ['surprise']
}

emotion_to_animation = {
    'happy': 'happy',
    'sad': 'sad',
    'angry': 'angry',
    'thinking': 'thinking',
    'surprised': 'surprised',
    'neutral': 'eyes_neutral'
}
```

---

**Status**: ‚úÖ Phase 5 Complete (Command Recognition + Nav2 + Twist Mux)  
**Next**: Phase 6 - Emotion Integration + Advanced Features (Vision, Following, Multi-step)
