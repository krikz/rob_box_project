#!/bin/bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏—Ç—ã—Ö —Å—Å—ã–ª–æ–∫ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
# –ò—â–µ—Ç –≤—Å–µ .md —Å—Å—ã–ª–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤

echo "üîó –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å—Å—ã–ª–æ–∫ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
echo "============================================="
echo ""

broken_count=0
checked_count=0

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–∑–æ–ª–≤–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π
resolve_path() {
    local base_dir="$1"
    local target="$2"
    
    # –£–±—Ä–∞—Ç—å —è–∫–æ—Ä—å (#...)
    target=$(echo "$target" | sed 's/#.*//')
    
    # –ï—Å–ª–∏ –ø—É—Ç—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å /, —ç—Ç–æ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –æ—Ç –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
    if [[ "$target" == /* ]]; then
        echo "$target"
    else
        # –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å
        echo "$(cd "$base_dir" && pwd)/$target"
    fi
}

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ MD —Ñ–∞–π–ª—ã –≤ docs/
while IFS= read -r file; do
    # –ò–∑–≤–ª–µ—á—å –≤—Å–µ markdown —Å—Å—ã–ª–∫–∏ –Ω–∞ .md —Ñ–∞–π–ª—ã
    grep -oE '\[([^\]]+)\]\(([^)]+\.md[^)]*)\)' "$file" 2>/dev/null | while read -r match; do
        # –ò–∑–≤–ª–µ—á—å URL –∏–∑ —Å—Å—ã–ª–∫–∏
        url=$(echo "$match" | sed -E 's/.*\(([^)]+)\).*/\1/')
        
        # –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤–Ω–µ—à–Ω–∏–µ —Å—Å—ã–ª–∫–∏
        if [[ "$url" =~ ^https?:// ]]; then
            continue
        fi
        
        checked_count=$((checked_count + 1))
        
        # –†–µ–∑–æ–ª–≤–∏—Ç—å –ø—É—Ç—å
        dir=$(dirname "$file")
        full_path=$(resolve_path "$dir" "$url")
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ
        if [ ! -f "$full_path" ]; then
            echo "‚ùå $file"
            echo "   ‚Üí $url"
            echo "   –û–∂–∏–¥–∞–µ—Ç—Å—è: $full_path"
            echo ""
            broken_count=$((broken_count + 1))
        fi
    done
done < <(find docs -name "*.md" -type f)

echo "============================================="
echo "–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —Å—Å—ã–ª–æ–∫: $checked_count"
if [ $broken_count -eq 0 ]; then
    echo "‚úÖ –í—Å–µ —Å—Å—ã–ª–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã!"
else
    echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω–æ –±–∏—Ç—ã—Ö —Å—Å—ã–ª–æ–∫: $broken_count"
fi
