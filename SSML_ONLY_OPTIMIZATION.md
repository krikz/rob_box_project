# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è JSON —Ñ–æ—Ä–º–∞—Ç–∞: —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—è `text`

**–î–∞—Ç–∞:** 13 –æ–∫—Ç—è–±—Ä—è 2025
**–í–µ—Ç–∫–∞:** feature/voice-assistant

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ streaming –æ—Ç–≤–µ—Ç–∞—Ö DeepSeek –≤–æ–∑–≤—Ä–∞—â–∞–ª JSON —Å –¥–≤—É–º—è –∏–∑–±—ã—Ç–æ—á–Ω—ã–º–∏ –ø–æ–ª—è–º–∏:
- `text` - –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –±–µ–∑ —É–¥–∞—Ä–µ–Ω–∏–π
- `ssml` - SSML —Å —É–¥–∞—Ä–µ–Ω–∏—è–º–∏ –∏ –ø–∞—É–∑–∞–º–∏

–ü–æ—Å–∫–æ–ª—å–∫—É —Å–∏—Å—Ç–µ–º–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç **—Ç–æ–ª—å–∫–æ SSML**, –ø–æ–ª–µ `text` –±—ã–ª–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–±—ã—Ç–æ—á–Ω—ã–º –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–ª–æ:
1. –†–∞–∑–º–µ—Ä –∫–∞–∂–¥–æ–≥–æ JSON chunk –Ω–∞ ~38%
2. –í—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏)
3. –ù–∞–≥—Ä—É–∑–∫—É –Ω–∞ DeepSeek (–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–≤–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞)

## –†–µ—à–µ–Ω–∏–µ

–£–±—Ä–∞–ª–∏ –ø–æ–ª–µ `text` –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞. –¢–µ–ø–µ—Ä—å DeepSeek –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ:
- `ssml` - SSML —Å —É–¥–∞—Ä–µ–Ω–∏—è–º–∏, –ø–∞—É–∑–∞–º–∏ –∏ –∏–Ω—Ç–æ–Ω–∞—Ü–∏—è–º–∏ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
- `emotion` - —ç–º–æ—Ü–∏—è –¥–ª—è LED –º–∞—Ç—Ä–∏—Ü—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `commands` - –∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–±–æ—Ç–æ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## –ò–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ü—Ä–æ–º–ø—Ç (`master_prompt.txt`)

**–ë—ã–ª–æ:**
```json
{
  "text": "–¢–µ–æ—Ä–µ–º–∞ –ü–∏—Ñ–∞–≥–æ—Ä–∞ –≥–ª–∞—Å–∏—Ç: ...",
  "ssml": "<speak>–¢–µ–æ—Ä+–µ–º–∞ –ü–∏—Ñ+–∞–≥–æ—Ä–∞ –≥–ª–∞—Å+–∏—Ç: ...</speak>",
  "emotion": "thinking"
}
```

**–°—Ç–∞–ª–æ:**
```json
{
  "ssml": "<speak>–¢–µ–æ—Ä+–µ–º–∞ –ü–∏—Ñ+–∞–≥–æ—Ä–∞ –≥–ª–∞—Å+–∏—Ç: ...</speak>",
  "emotion": "thinking"
}
```

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–±—Ä–∞–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –ø–æ–ª—è `text` ("–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å")
- –î–æ–±–∞–≤–ª–µ–Ω–æ "–ù–ï –¥–æ–±–∞–≤–ª—è–π—Ç–µ –ø–æ–ª–µ `text` - –æ–Ω–æ –∏–∑–±—ã—Ç–æ—á–Ω–æ"
- –î–æ–±–∞–≤–ª–µ–Ω–æ "–ü–æ–ª–µ `ssml` –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≤–µ—Å—å —Ç–µ–∫—Å—Ç"
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –ø—Ä–∏–º–µ—Ä—ã –≤ –ø—Ä–æ–º–ø—Ç–µ

### 2. –ö–æ–¥ –ø–∞—Ä—Å–∏–Ω–≥–∞ (`robbox_chat_streaming.py`)

**–ë—ã–ª–æ:**
```python
def _speak_chunk(self, chunk_data: dict):
    text = chunk_data.get('text', '')
    normalized = self.voice_handler.parser.base_normalizer.normalize(text)
    
    ssml = chunk_data.get('ssml', None)
    if ssml:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º SSML
        ...
    else:
        # –û–∑–≤—É—á–∏–≤–∞–µ–º text
        self.tts.synthesize_and_play(normalized, speaker='aidar')
```

**–°—Ç–∞–ª–æ:**
```python
def _speak_chunk(self, chunk_data: dict):
    ssml = chunk_data.get('ssml', '')
    
    if not ssml:
        print("‚ö†Ô∏è  –ü—É—Å—Ç–æ–π SSML –≤ chunk, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
        return
    
    # –ü–∞—Ä—Å–∏–º SSML –∏ –æ–∑–≤—É—á–∏–≤–∞–µ–º
    ssml_chunks = self.voice_handler.ssml_processor.parse_ssml_for_timing(ssml)
    for ssml_text, pause_ms in ssml_chunks:
        normalized = self.voice_handler.parser.base_normalizer.normalize(ssml_text)
        self.tts.synthesize_and_play(normalized, speaker='aidar')
        if pause_ms:
            time.sleep(pause_ms / 1000.0)
```

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–±—Ä–∞–Ω fallback –Ω–∞ –ø–æ–ª–µ `text`
- SSML —Å—Ç–∞–ª –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º —Ç–µ–∫—Å—Ç–∞
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è (–ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã) –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ SSML
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π SSML —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º

### 3. –£–ª—É—á—à–µ–Ω –ø–∞—Ä—Å–∏–Ω–≥ JSON

–¢–∞–∫–∂–µ –±—ã–ª —É–ª—É—á—à–µ–Ω –ø–∞—Ä—Å–∏–Ω–≥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–º–∏ JSON (DeepSeek –∏–Ω–æ–≥–¥–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç JSON —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏):

**–ë—ã–ª–æ:**
- –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ (\n-delimited JSON)
- –ù–µ —Ä–∞–±–æ—Ç–∞–ª–æ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º JSON

**–°—Ç–∞–ª–æ:**
- –ü–∞—Ä—Å–∏–Ω–≥ —Å –ø–æ–¥—Å—á—ë—Ç–æ–º —Ñ–∏–≥—É—Ä–Ω—ã—Ö —Å–∫–æ–±–æ–∫ `{}`
- –†–∞–±–æ—Ç–∞–µ—Ç –∏ —Å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º, –∏ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º JSON
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç markdown –±–ª–æ–∫–∏ (\`\`\`json ... \`\`\`)

```python
# –ù–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º
brace_count = 0
in_json = False
current_chunk = ""

for token in stream:
    if '{' in token and not in_json:
        in_json = True
        current_chunk = token[token.index('{'):]
        brace_count = current_chunk.count('{') - current_chunk.count('}')
    
    elif in_json:
        current_chunk += token
        brace_count += token.count('{') - token.count('}')
        
        if brace_count == 0:  # –°–∫–æ–±–∫–∏ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω—ã = –ø–æ–ª–Ω—ã–π JSON
            chunk_data = json.loads(current_chunk)
            _speak_chunk(chunk_data)
            # –°–±—Ä–æ—Å –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ chunk
            current_chunk = ""
            in_json = False
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –≠–∫–æ–Ω–æ–º–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞

**–ü—Ä–∏–º–µ—Ä chunk:**
- **–°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç:** 510 –±–∞–π—Ç
- **–ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç:** 321 –±–∞–π—Ç
- **–≠–∫–æ–Ω–æ–º–∏—è:** 189 –±–∞–π—Ç (**38% –º–µ–Ω—å—à–µ**)

**–î–ª—è —Ç–∏–ø–∏—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (6 chunks):**
- **–°—Ç–∞—Ä—ã–π:** ~3 –ö–ë
- **–ù–æ–≤—ã–π:** ~1.9 –ö–ë
- **–≠–∫–æ–Ω–æ–º–∏—è:** ~1.1 –ö–ë (**38% –º–µ–Ω—å—à–µ**)

### –£–ª—É—á—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞

–ú–µ–Ω—å—à–∏–π JSON ‚Üí –±—ã—Å—Ç—Ä–µ–µ –ø–µ—Ä–µ–¥–∞—á–∞ ‚Üí **–±—ã—Å—Ç—Ä–µ–µ –ø–µ—Ä–≤—ã–π chunk**

–î–ª—è –ø–µ—Ä–≤–æ–≥–æ chunk (~300 –±–∞–π—Ç):
- –≠–∫–æ–Ω–æ–º–∏—è: ~110 –±–∞–π—Ç
- –ù–∞ 4G (20 –ú–±–∏—Ç/—Å ‚âà 2.5 –ú–ë/—Å): **~0.04 –º—Å** —ç–∫–æ–Ω–æ–º–∏–∏
- –ù–∞ WiFi: –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ

**–û—Å–Ω–æ–≤–Ω–∞—è –≤—ã–≥–æ–¥–∞:** –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ DeepSeek (–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–¥–∏–Ω —Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ –¥–≤—É—Ö)

### –£–ø—Ä–æ—â–µ–Ω–∏–µ –∫–æ–¥–∞

- –£–±—Ä–∞–Ω –Ω–µ–Ω—É–∂–Ω—ã–π fallback –Ω–∞ `text`
- –ï–¥–∏–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—Ç–æ–ª—å–∫–æ SSML)
- –ú–µ–Ω—å—à–µ –º–µ—Å—Ç –¥–ª—è –æ—à–∏–±–æ–∫

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç
```bash
$ python3 -c "bot.ask_deepseek_streaming('–ü—Ä–∏–≤–µ—Ç')"
üì¶ Chunk 1: {"ssml": "<speak><prosody pitch='high'>–ü—Ä–∏–≤+–µ—Ç!</prosody>..."}
üîä –ì–æ–≤–æ—Ä—é: –ü—Ä–∏–≤+–µ—Ç!
```
‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–ª–µ `text` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

### –¢–µ—Å—Ç 2: –î–ª–∏–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (6 chunks)
```bash
$ python3 -c "bot.ask_deepseek_streaming('—Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –°–æ—á–∏ –ø–æ–¥—Ä–æ–±–Ω–æ')"
üì¶ Chunk 1: {"chunk": 1, "ssml": "<speak>–°+–æ—á–∏..."}
üîä –ì–æ–≤–æ—Ä—é: –°+–æ—á–∏‚Äî —ç—Ç–æ –∫—Ä+—É–ø–Ω—ã–π –∫—É—Ä+–æ—Ä—Ç–Ω—ã–π –≥+–æ—Ä–æ–¥...
üì¶ Chunk 2: {"chunk": 2, "ssml": "<speak>–†–∞—Å–ø–æ–ª+–æ–∂–µ–Ω..."}
üîä –ì–æ–≤–æ—Ä—é: –†–∞—Å–ø–æ–ª+–æ–∂–µ–Ω –Ω–∞ —á+–µ—Ä–Ω–æ–º–æ—Ä—Å–∫–æ–º...
...
üì¶ Chunk 6: {"chunk": 6, "ssml": "<speak>–í –°+–æ—á–∏ –Ω–∞—Ö+–æ–¥—è—Ç—Å—è..."}
```
‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç, –≤—Å–µ 6 chunks –æ–∑–≤—É—á–µ–Ω—ã

### –¢–µ—Å—Ç 3: –§–æ—Ä–º—É–ª—ã –∏ —É–¥–∞—Ä–µ–Ω–∏—è
```bash
$ python3 -c "bot.ask_deepseek_streaming('—Ç–µ–æ—Ä–µ–º–∞ –ø–∏—Ñ–∞–≥–æ—Ä–∞ —Å —Ñ–æ—Ä–º—É–ª–æ–π')"
üì¶ Chunk 1: {"ssml": "<speak>–¢–µ–æ—Ä+–µ–º–∞ –ü–∏—Ñ+–∞–≥–æ—Ä–∞ –≥–ª–∞—Å+–∏—Ç:..."}
üîä –ì–æ–≤–æ—Ä—é: –¢–µ–æ—Ä+–µ–º–∞ –ü–∏—Ñ+–∞–≥–æ—Ä–∞ –≥–ª–∞—Å+–∏—Ç: –≤ –ø—Ä—è–º–æ—É–≥+–æ–ª—å–Ω–æ–º...
```
‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç, —É–¥–∞—Ä–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ, —Ñ–æ—Ä–º—É–ª–∞ —Ç–µ–∫—Å—Ç–æ–º

## –í—ã–≤–æ–¥—ã

‚úÖ **–£—Å–ø–µ—à–Ω–æ —É–±—Ä–∞–ª–∏ –∏–∑–±—ã—Ç–æ—á–Ω–æ–µ –ø–æ–ª–µ `text`**
‚úÖ **–≠–∫–æ–Ω–æ–º–∏—è 38% —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ –∫–∞–∂–¥–æ–º chunk**
‚úÖ **–£–ø—Ä–æ—â—ë–Ω –∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏**
‚úÖ **–£–ª—É—á—à–µ–Ω –ø–∞—Ä—Å–∏–Ω–≥ JSON (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º)**
‚úÖ **–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã**

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

1. `src/rob_box_voice/prompts/master_prompt.txt`
   - –£–±—Ä–∞–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –ø–æ–ª—è `text`
   - –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ/–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞

2. `src/rob_box_voice/scripts/robbox_chat_streaming.py`
   - –ú–µ—Ç–æ–¥ `_speak_chunk()` - —É–±—Ä–∞–Ω fallback –Ω–∞ `text`
   - –£–ª—É—á—à–µ–Ω –ø–∞—Ä—Å–∏–Ω–≥ JSON (–ø–æ–¥—Å—á—ë—Ç —Ñ–∏–≥—É—Ä–Ω—ã—Ö —Å–∫–æ–±–æ–∫)
   - –î–æ–±–∞–≤–ª–µ–Ω DEBUG —Ä–µ–∂–∏–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

3. `src/rob_box_voice/scripts/test_streaming_ssml_only.py`
   - –ù–æ–≤—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

‚ö†Ô∏è **Breaking change:** –°—Ç–∞—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã —Å –ø–æ–ª–µ–º `text` –±–æ–ª—å—à–µ –Ω–µ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ –ø–æ–ª–µ.

–û–¥–Ω–∞–∫–æ –∫–æ–¥ **–æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º** - –µ—Å–ª–∏ –ø—Ä–∏–¥—ë—Ç JSON —Å `text`, –æ–Ω –ø—Ä–æ—Å—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω, –∞ SSML –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∫–∞–∫ –æ–±—ã—á–Ω–æ.

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
2. ‚è≥ –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ DeepSeek –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π JSON –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
3. ‚è≥ –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤ (–≤—Å–µ —É–¥–∞—Ä–µ–Ω–∏—è –Ω–∞ –º–µ—Å—Ç–µ?)
4. ‚è≥ Commit –∏ push –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –≤–µ—Ç–∫—É feature/voice-assistant
